<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∏–¥–∫–∏ ‚Äî AURA Admin</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                    <div class="topbar-search">
                        <input type="text" class="topbar-search-input" placeholder="–ü–æ–∏—Å–∫... (–Ω–∞–∂–º–∏—Ç–µ /)"
                            id="global-search">
                        <span class="topbar-search-icon">üîç</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">–°–∫–∏–¥–∫–∏</h1>
                        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Å–∫–∏–¥–∫–∞–º–∏</p>
                    </div>
                    <button class="btn btn-primary" onclick="openDiscountModal()">
                        + –°–æ–∑–¥–∞—Ç—å —Å–∫–∏–¥–∫—É
                    </button>
                </div>

                <!-- Discounts Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                        <th>–£—Å–ª–æ–≤–∏—è</th>
                                        <th>–ü–µ—Ä–∏–æ–¥</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th class="text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="discountsTable">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Discount Modal -->
    <div class="modal" id="discountModal">
        <div class="modal-backdrop"></div>
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">–ù–æ–≤–∞—è —Å–∫–∏–¥–∫–∞</h2>
                    <button class="modal-close" onclick="closeDiscountModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <form id="discountForm">
                        <input type="hidden" name="id" id="discountId">

                        <div class="form-group">
                            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–∏–¥–∫–∏ *</label>
                            <input type="text" id="name" name="name" placeholder="–õ–µ—Ç–Ω—è—è —Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞" required>
                        </div>

                        <div class="form-group">
                            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea id="description" name="description" rows="2"
                                placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ü–∏–∏"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="type">–¢–∏–ø —Å–∫–∏–¥–∫–∏ *</label>
                                <select id="type" name="type" onchange="updateDiscountType()" required>
                                    <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                                    <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="value">–ó–Ω–∞—á–µ–Ω–∏–µ *</label>
                                <input type="number" id="value" name="value" placeholder="10" min="0" step="0.01"
                                    required>
                                <small class="text-muted" id="valueHint">–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (0-100)</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="target">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ *</label>
                            <select id="target" name="target" onchange="toggleTargetOptions()" required>
                                <option value="all">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
                                <option value="category">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</option>
                                <option value="collection">–ö–æ–ª–ª–µ–∫—Ü–∏—è</option>
                                <option value="products">–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</option>
                            </select>
                        </div>

                        <!-- Category select -->
                        <div id="categorySelect" class="form-group" style="display: none;">
                            <label for="categoryId">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</label>
                            <select id="categoryId" name="categoryId">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            </select>
                        </div>

                        <!-- Collection select -->
                        <div id="collectionSelect" class="form-group" style="display: none;">
                            <label for="collectionId">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</label>
                            <select id="collectionId" name="collectionId">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>
                            </select>
                        </div>

                        <!-- Products select -->
                        <div id="productsSelect" class="form-group" style="display: none;">
                            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã</label>
                            <div class="product-selector" id="productSelector">
                                <!-- Dynamic product checkboxes -->
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="minAmount">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞</label>
                            <input type="number" id="minAmount" name="minAmount" placeholder="0" min="0" step="0.01">
                            <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —É—Å–ª–æ–≤–∏—è</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                <input type="datetime-local" id="startDate" name="startDate">
                            </div>

                            <div class="form-group">
                                <label for="endDate">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="datetime-local" id="endDate" name="endDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="priority">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <input type="number" id="priority" name="priority" value="0" min="0">
                                <small class="text-muted">–ß–µ–º –≤—ã—à–µ —á–∏—Å–ª–æ, —Ç–µ–º –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</small>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="isActive" id="isActive" checked>
                                    –ê–∫—Ç–∏–≤–Ω–∞
                                </label>
                                <br>
                                <label style="margin-top: 8px;">
                                    <input type="checkbox" name="combineWithOther" id="combineWithOther">
                                    –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ —Å–∫–∏–¥–∫–∞–º–∏
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDiscountModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveDiscount()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/admin/repo.js"></script>
    <script src="/admin/seed.js"></script>
    <script src="/admin/components.js"></script>

    <script>
        let currentDiscountId = null;
        let allCategories = [];
        let allCollections = [];
        let allProducts = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDiscounts();
            setupSidebar();
            setupSearch();
        });

        // Load discounts
        async function loadDiscounts() {
            try {
                const discounts = await API.discounts.getAll();
                const tbody = document.getElementById('discountsTable');

                if (discounts.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <p>–ù–µ—Ç —Å–∫–∏–¥–æ–∫</p>
                                <button class="btn btn-primary" onclick="openDiscountModal()">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Å–∫–∏–¥–∫—É</button>
                            </div>
                        </td>
                    </tr>
                `;
                    return;
                }

                tbody.innerHTML = discounts.map(discount => {
                    const isActive = discount.is_active ?? discount.isActive;
                    const statusBadge = isActive
                        ? '<span class="badge badge-success">–ê–∫—Ç–∏–≤–Ω–∞</span>'
                        : '<span class="badge badge-secondary">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>';

                    const discountType = discount.discount_type || discount.type;
                    const discountValue = discount.discount_value ?? discount.value;
                    const typeLabel = discountType === 'percent' ? '%' : ' –°—É–º–º';
                    const valueDisplay = `${discountValue}${typeLabel}`;

                    const targetLabels = {
                        all: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã',
                        category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
                        collection: '–ö–æ–ª–ª–µ–∫—Ü–∏—è',
                        products: '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã'
                    };

                    let conditions = [];
                    const minAmount = discount.min_amount ?? discount.minAmount;
                    if (minAmount) {
                        conditions.push(`–û—Ç ${Components.formatPrice(minAmount)}`);
                    }
                    const conditionsText = conditions.length > 0 ? conditions.join(', ') : '‚Äî';

                    const now = new Date();
                    const startDate = discount.start_date || discount.startDate;
                    const endDate = discount.end_date || discount.endDate;
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;

                    let period = '–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π';
                    if (start && end) {
                        period = `${formatShortDate(start)} - ${formatShortDate(end)}`;
                    } else if (start) {
                        period = `–° ${formatShortDate(start)}`;
                    } else if (end) {
                        period = `–î–æ ${formatShortDate(end)}`;
                    }

                    const isScheduleActive = (!start || now >= start) && (!end || now <= end);
                    const scheduleIndicator = !isScheduleActive && isActive
                        ? ' <small class="text-muted">(–Ω–µ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏)</small>'
                        : '';

                    return `
                    <tr>
                        <td>
                            <strong>${discount.name}</strong>
                            ${discount.description ? `<br><small class="text-muted">${discount.description}</small>` : ''}
                        </td>
                        <td>${discountType === 'percent' ? '–ü—Ä–æ—Ü–µ–Ω—Ç' : '–§–∏–∫—Å. —Å—É–º–º–∞'}</td>
                        <td><strong class="text-accent">${valueDisplay}</strong></td>
                        <td>
                            ${targetLabels[discount.target] || discount.target}
                            ${conditionsText !== '‚Äî' ? `<br><small class="text-muted">${conditionsText}</small>` : ''}
                        </td>
                        <td><small>${period}</small></td>
                        <td>${statusBadge}${scheduleIndicator}</td>
                        <td class="text-right">
                            <button class="btn btn-sm btn-secondary" onclick="editDiscount('${discount.id}')">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDiscount('${discount.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `;
                }).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–¥–æ–∫:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∫–∏–¥–∫–∏', 'error');
                document.getElementById('discountsTable').innerHTML = `
                    <tr><td colspan="7" class="text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>
                `;
            }
        }

        // Format short date
        function formatShortDate(date) {
            return new Intl.DateTimeFormat('ru-RU', {
                day: 'numeric',
                month: 'short'
            }).format(date);
        }

        // Open modal
        async function openDiscountModal(id = null) {
            const modal = document.getElementById('discountModal');
            const form = document.getElementById('discountForm');
            const title = document.getElementById('modalTitle');

            currentDiscountId = id;
            form.reset();

            try {
                // Load data
                allCategories = await API.categories.getAll();
                allCollections = await API.collections.getAll();
                const products = await API.products.getAll();
                allProducts = products.filter(p => p.status === 'active');

                populateCategorySelector();
                populateCollectionSelector();
                populateProductSelector();

                if (id) {
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∏–¥–∫—É';
                    const discount = await API.discounts.getById(id);

                    document.getElementById('discountId').value = discount.id;
                    document.getElementById('name').value = discount.name;
                    document.getElementById('description').value = discount.description || '';
                    document.getElementById('type').value = discount.discount_type || discount.type;
                    document.getElementById('value').value = discount.discount_value ?? discount.value;
                    document.getElementById('target').value = discount.target;
                    document.getElementById('minAmount').value = discount.min_amount ?? discount.minAmount ?? '';
                    document.getElementById('priority').value = discount.priority || 0;
                    document.getElementById('isActive').checked = discount.is_active ?? discount.isActive;
                    document.getElementById('combineWithOther').checked = discount.combine_with_other ?? discount.combineWithOther ?? false;

                    const startDate = discount.start_date || discount.startDate;
                    if (startDate) {
                        document.getElementById('startDate').value = startDate.split('T')[0];
                    }

                    const endDate = discount.end_date || discount.endDate;
                    if (endDate) {
                        document.getElementById('endDate').value = endDate.split('T')[0];
                    }

                    // Set target-specific fields
                    if (discount.target === 'category') {
                        const categoryId = discount.category_id || discount.categoryId;
                        document.getElementById('categoryId').value = categoryId || '';
                    } else if (discount.target === 'collection') {
                        const collectionId = discount.collection_id || discount.collectionId;
                        document.getElementById('collectionId').value = collectionId || '';
                    } else if (discount.target === 'products') {
                        const productIds = discount.product_ids || discount.productIds;
                        if (Array.isArray(productIds)) {
                            productIds.forEach(productId => {
                                const checkbox = document.querySelector(`#productSelector input[value="${productId}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }

                    updateDiscountType();
                    toggleTargetOptions();
                } else {
                    title.textContent = '–ù–æ–≤–∞—è —Å–∫–∏–¥–∫–∞';
                    updateDiscountType();
                }

                modal.classList.add('active');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∫–∏–¥–∫–∏:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', 'error');
            }
        }

        // Close modal
        function closeDiscountModal() {
            document.getElementById('discountModal').classList.remove('active');
            currentDiscountId = null;
        }

        // Update discount type hint
        function updateDiscountType() {
            const type = document.getElementById('type').value;
            const hint = document.getElementById('valueHint');
            const valueInput = document.getElementById('value');

            if (type === 'percent') {
                hint.textContent = '–ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏ (0-100)';
                valueInput.max = 100;
            } else {
                hint.textContent = '–°—É–º–º–∞ —Å–∫–∏–¥–∫–∏ –≤ —Ä—É–±–ª—è—Ö';
                valueInput.removeAttribute('max');
            }
        }

        // Toggle target options
        function toggleTargetOptions() {
            const target = document.getElementById('target').value;

            document.getElementById('categorySelect').style.display = target === 'category' ? 'block' : 'none';
            document.getElementById('collectionSelect').style.display = target === 'collection' ? 'block' : 'none';
            document.getElementById('productsSelect').style.display = target === 'products' ? 'block' : 'none';
        }

        // Populate selectors
        function populateCategorySelector() {
            const select = document.getElementById('categoryId');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>' +
                allCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }

        function populateCollectionSelector() {
            const select = document.getElementById('collectionId');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é</option>' +
                allCollections.map(col => `<option value="${col.id}">${col.name}</option>`).join('');
        }

        function populateProductSelector() {
            const container = document.getElementById('productSelector');
            if (allProducts.length === 0) {
                container.innerHTML = '<p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>';
                return;
            }

            container.innerHTML = allProducts.map(product => `
                <label class="product-checkbox">
                    <input type="checkbox" value="${product.id}">
                    <span>${product.title} ‚Äî ${Components.formatPrice(product.price)}</span>
                </label>
            `).join('');
        }

        // Save discount
        async function saveDiscount() {
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const type = document.getElementById('type').value;
            const value = parseFloat(document.getElementById('value').value);
            const target = document.getElementById('target').value;
            const minAmount = parseFloat(document.getElementById('minAmount').value) || null;
            const priority = parseInt(document.getElementById('priority').value) || 0;
            const isActive = document.getElementById('isActive').checked;
            const combineWithOther = document.getElementById('combineWithOther').checked;
            const startDate = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value).toISOString() : null;
            const endDate = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value).toISOString() : null;

            if (!name || isNaN(value)) {
                Components.showToast('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (type === 'percent' && (value < 0 || value > 100)) {
                Components.showToast('–û—à–∏–±–∫–∞', '–ü—Ä–æ—Ü–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 100', 'error');
                return;
            }

            const data = {
                name,
                description,
                type,
                value,
                target,
                minAmount,
                priority,
                isActive,
                combineWithOther,
                startDate,
                endDate
            };

            // Add target-specific data
            if (target === 'category') {
                data.categoryId = document.getElementById('categoryId').value;
                if (!data.categoryId) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
                    return;
                }
            } else if (target === 'collection') {
                data.collectionId = document.getElementById('collectionId').value;
                if (!data.collectionId) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏—é', 'error');
                    return;
                }
            } else if (target === 'products') {
                const checkboxes = document.querySelectorAll('#productSelector input:checked');
                data.productIds = Array.from(checkboxes).map(cb => cb.value);
                if (data.productIds.length === 0) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä', 'error');
                    return;
                }
            }

            // Map to snake_case for API
            const apiData = {
                name: data.name,
                description: data.description,
                discount_type: data.type,
                discount_value: data.value,
                target: data.target,
                min_amount: data.minAmount || null,
                priority: data.priority,
                is_active: data.isActive,
                combine_with_other: data.combineWithOther,
                start_date: data.startDate || null,
                end_date: data.endDate || null,
                category_id: data.categoryId || null,
                collection_id: data.collectionId || null,
                product_ids: data.productIds ? JSON.stringify(data.productIds) : null
            };

            try {
                if (currentDiscountId) {
                    await API.discounts.update(currentDiscountId, apiData);
                    Components.showToast('–£—Å–ø–µ—Ö', '–°–∫–∏–¥–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                } else {
                    await API.discounts.create(apiData);
                    Components.showToast('–£—Å–ø–µ—Ö', '–°–∫–∏–¥–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                }

                closeDiscountModal();
                await loadDiscounts();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É', 'error');
            }
        }

        // Edit discount
        function editDiscount(id) {
            openDiscountModal(id);
        }

        // Delete discount
        async function deleteDiscount(id) {
            try {
                const discount = await API.discounts.getById(id);

                Components.confirm(
                    '–£–¥–∞–ª–∏—Ç—å —Å–∫–∏–¥–∫—É?',
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–∫–∏–¥–∫—É "${discount.name}"?`,
                    async () => {
                        try {
                            await API.discounts.delete(id);
                            Components.showToast('–£—Å–ø–µ—Ö', '–°–∫–∏–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                            await loadDiscounts();
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏:', error);
                            Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–∫–∏–¥–∫—É', 'error');
                        }
                    }
                );
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–∏–¥–∫–∏:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∫–∏–¥–∫–∏', 'error');
            }
        }

        // Sidebar & Search
        function setupSidebar() {
            document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('sidebar-collapsed');
            });
        }

        function setupSearch() {
            const input = document.getElementById('global-search');
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') input.blur();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && document.activeElement !== input) {
                    e.preventDefault();
                    input?.focus();
                }
            });
        }
    </script>
</body>

</html>