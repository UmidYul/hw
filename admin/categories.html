<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ - AURA Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1>
                        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="openCategoryModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    </div>
                </div>

                <div class="card">
                    <div id="categories-container">
                        <div class="card-body">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="category-modal">
        <div class="modal-backdrop" onclick="closeCategoryModal()"></div>
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è</h3>
                <button class="modal-close" onclick="closeCategoryModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="category-form">
                    <div class="form-group">
                        <label class="form-label form-label-required">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-input" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Slug</label>
                        <input type="text" class="form-input" name="slug">
                        <div class="form-hint">URL-–∞–¥—Ä–µ—Å (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-textarea" name="description" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" name="visibility" checked>
                            <span>–í–∏–¥–∏–º–∞—è</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCategoryModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/repo.js"></script>
    <script src="/admin/seed.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        let editingId = null;

        async function loadCategories() {
            try {
                const [categories, products] = await Promise.all([
                    API.categories.getAll(),
                    API.products.getAll()
                ]);
                const container = document.getElementById('categories-container');

                if (categories.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><div class="empty-state-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç</div></div>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>';
                html += '<th>Slug</th>';
                html += '<th>–¢–æ–≤–∞—Ä–æ–≤</th>';
                html += '<th>–í–∏–¥–∏–º–æ—Å—Ç—å</th>';
                html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
                html += '</tr></thead><tbody>';

                categories.forEach(cat => {
                    const count = products.filter(p => p.category === cat.id).length;
                    const isVisible = cat.is_visible !== undefined ? cat.is_visible : cat.visibility;
                    html += `<tr>
                    <td><strong>${cat.name}</strong><br><small class="text-muted">${cat.description || ''}</small></td>
                    <td><code>${cat.slug}</code></td>
                    <td>${count}</td>
                    <td>${isVisible ? Components.renderBadge('–í–∏–¥–∏–º–∞', 'success') : Components.renderBadge('–°–∫—Ä—ã—Ç–∞', 'default')}</td>
                    <td>
                        <button class="btn btn-sm btn-ghost" onclick="editCategory('${cat.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteCategory('${cat.id}', ${count})">üóëÔ∏è</button>
                    </td>
                </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load categories:', error);
                document.getElementById('categories-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div></div>';
            }
        }

        async function openCategoryModal(id = null) {
            editingId = id;
            const form = document.getElementById('category-form');
            form.reset();

            if (id) {
                try {
                    const category = await API.categories.getById(id);
                    if (category) {
                        document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                        form.querySelector('[name="name"]').value = category.name;
                        form.querySelector('[name="slug"]').value = category.slug;
                        form.querySelector('[name="description"]').value = category.description || '';
                        form.querySelector('[name="visibility"]').checked = category.is_visible !== undefined ? category.is_visible : category.visibility;
                    }
                } catch (error) {
                    console.error('Failed to load category:', error);
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = '–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
            }

            document.getElementById('category-modal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.remove('show');
            editingId = null;
        }

        function generateSlug(text) {
            return text.toLowerCase()
                .replace(/[–∞-—è—ë]/g, (char) => {
                    const map = { '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'e', '–∂': 'zh', '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya' };
                    return map[char] || char;
                })
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        async function saveCategory() {
            const form = document.getElementById('category-form');
            const name = form.querySelector('[name="name"]').value.trim();

            if (!name) {
                Components.showToast('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', 'error');
                return;
            }

            let slug = form.querySelector('[name="slug"]').value.trim();
            if (!slug) {
                slug = generateSlug(name);
            }

            const data = {
                name,
                slug,
                description: form.querySelector('[name="description"]').value,
                is_visible: form.querySelector('[name="visibility"]').checked,
                order_index: 0
            };

            try {
                if (editingId) {
                    await API.categories.update(editingId, data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                } else {
                    await API.categories.create(data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
                }

                closeCategoryModal();
                await loadCategories();
            } catch (error) {
                console.error('Failed to save category:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
            }
        }

        function editCategory(id) {
            openCategoryModal(id);
        }

        async function deleteCategory(id, productCount) {
            if (productCount > 0) {
                Components.showToast('–û—à–∏–±–∫–∞', `–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${productCount} —Ç–æ–≤–∞—Ä–æ–≤. –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∏—Ö.`, 'error');
                return;
            }

            Components.confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?', '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', async () => {
                try {
                    await API.categories.delete(id);
                    await loadCategories();
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                } catch (error) {
                    console.error('Failed to delete category:', error);
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é', 'error');
                }
            });
        }

        // Auto-generate slug
        document.getElementById('category-form').querySelector('[name="name"]').addEventListener('input', (e) => {
            if (!editingId) {
                const slugInput = document.getElementById('category-form').querySelector('[name="slug"]');
                slugInput.value = generateSlug(e.target.value);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadCategories, 300);
        });
    </script>
</body>

</html>