<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки - Higher Waist</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon"></div>
                    <div class="sidebar-logo-text">Higher Waist</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Основное</div>
                    <a href="/admin" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Каталог</div>
                    <a href="/admin/products" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Товары</span>
                    </a>
                    <a href="/admin/categories" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Категории</span>
                    </a>
                    <a href="/admin/collections" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Коллекции</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Маркетинг</div>
                    <a href="/admin/discounts" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Скидки</span>
                    </a>
                    <a href="/admin/promocodes" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Промокоды</span>
                    </a>
                    <a href="/admin/banners" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Баннеры</span>
                    </a>
                    <a href="/admin/newsletters" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Рассылки</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Продажи</div>
                    <a href="/admin/orders" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Заказы</span>
                    </a>
                    <a href="/admin/customers" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Клиенты</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Контент</div>
                    <a href="/admin/pages" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Страницы</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Настройки</div>
                    <a href="/admin/settings" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon"></span>
                        <span>Настройки</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">Меню</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">Администратор</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Настройки</h1>
                        <p class="page-subtitle">Конфигурация магазина</p>
                    </div>
                </div>

                <form id="settings-form">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Основная информация</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Название магазина</label>
                                    <input type="text" class="form-input" name="storeName">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Логотип (текст)</label>
                                    <input type="text" class="form-input" name="logoText">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Логотип сайта (favicon)</label>
                                <input type="hidden" name="logoIcon" id="logoIcon">
                                <div class="file-upload">
                                    <input type="file" id="logoIconFile" accept="image/*">
                                    <button type="button" class="file-upload-button" id="logoIconFileBtn">Выбрать
                                        файл</button>
                                    <span class="file-upload-name" id="logoIconFileName">Файл не выбран</span>
                                </div>
                                <div class="file-preview" id="logoIconPreview">
                                    <div class="file-preview-empty">Превью favicon</div>
                                </div>
                                <small class="text-muted" id="logoIconUploadStatus">Рекомендуется PNG/ICO до 1MB</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Описание</label>
                                <textarea class="form-textarea" name="storeDescription" rows="3"></textarea>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" name="contactEmail">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Телефон</label>
                                    <input type="tel" class="form-input" name="contactPhone">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Соцсети</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Instagram</label>
                                    <input type="url" class="form-input" name="socialInstagram"
                                        placeholder="https://instagram.com/...">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Facebook</label>
                                    <input type="url" class="form-input" name="socialFacebook"
                                        placeholder="https://facebook.com/...">
                                </div>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Telegram</label>
                                    <input type="url" class="form-input" name="socialTelegram"
                                        placeholder="https://t.me/...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">WhatsApp</label>
                                    <input type="url" class="form-input" name="socialWhatsapp"
                                        placeholder="https://wa.me/...">
                                </div>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">TikTok</label>
                                    <input type="url" class="form-input" name="socialTiktok"
                                        placeholder="https://tiktok.com/@...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">YouTube</label>
                                    <input type="url" class="form-input" name="socialYoutube"
                                        placeholder="https://youtube.com/@...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Цветовая палитра</h3>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="colorPalette" id="colorPaletteValue">
                            <div class="color-palette-list" id="colorPaletteList"></div>
                            <button type="button" class="btn btn-secondary" id="addColorBtn">Добавить цвет</button>
                            <div class="form-hint">Используется в фильтрах и карточках товаров.</div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Размеры</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Список размеров (через запятую)</label>
                                <input type="text" class="form-input" name="sizesList" placeholder="XS, S, M, L, XL">
                                <div class="form-hint">Используется в таблице остатков по вариантам.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Доставка</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Бесплатная доставка от (Сумм)</label>
                                    <input type="number" class="form-input" name="freeShippingThreshold" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Стоимость доставки (Сумм)</label>
                                    <input type="number" class="form-input" name="flatShippingRate" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Налоги</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="enableTaxes">
                                    <span>Включить налоги</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">НДС (%)</label>
                                <input type="number" class="form-input" name="taxPercent" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Политики</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Политика возврата</label>
                                <textarea class="form-textarea" name="returnPolicy" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Политика конфиденциальности</label>
                                <textarea class="form-textarea" name="privacyPolicy" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Безопасность</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label" for="currentPassword">Текущий пароль</label>
                                    <input type="password" class="form-input" id="currentPassword"
                                        autocomplete="current-password">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="newPassword">Новый пароль</label>
                                    <input type="password" class="form-input" id="newPassword"
                                        autocomplete="new-password">
                                </div>
                            </div>
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label" for="confirmPassword">Повторите новый пароль</label>
                                    <input type="password" class="form-input" id="confirmPassword"
                                        autocomplete="new-password">
                                </div>
                                <div class="form-group" style="display: flex; align-items: end;">
                                    <button type="button" class="btn btn-secondary" onclick="changeAdminPassword()">
                                        Изменить пароль
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Очистка файлов</h3>
                        </div>
                        <div class="card-body">
                            <p class="form-hint">Удаляет изображения товаров и баннеров, которые не используются.</p>
                            <div class="flex gap-md" style="align-items: center; flex-wrap: wrap;">
                                <select class="form-select" id="cleanupUploadsType" style="min-width: 220px;">
                                    <option value="all">Товары + баннеры</option>
                                    <option value="products">Только товары</option>
                                    <option value="banners">Только баннеры</option>
                                </select>
                                <button type="button" class="btn btn-secondary" id="cleanupUploadsBtn"
                                    onclick="runUploadsCleanup()">
                                    <span class="spinner" aria-hidden="true"></span>
                                    <span class="btn-text">Очистить неиспользуемые</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-lg">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить
                            настройки</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        async function loadSettings() {
            try {
                const settings = await API.settings.get();
                const form = document.getElementById('settings-form');

                // Map database fields to form fields
                const fieldMap = {
                    'site_name': 'storeName',
                    'logo_text': 'logoText',
                    'logo_icon': 'logoIcon',
                    'store_description': 'storeDescription',
                    'contact_email': 'contactEmail',
                    'contact_phone': 'contactPhone',
                    'social_instagram': 'socialInstagram',
                    'social_facebook': 'socialFacebook',
                    'social_telegram': 'socialTelegram',
                    'social_tiktok': 'socialTiktok',
                    'social_youtube': 'socialYoutube',
                    'social_whatsapp': 'socialWhatsapp',
                    'color_palette': 'colorPalette',
                    'sizes_list': 'sizesList',
                    'free_shipping_threshold': 'freeShippingThreshold',
                    'shipping_cost': 'flatShippingRate',
                    'enable_taxes': 'enableTaxes',
                    'vat_rate': 'taxPercent',
                    'return_policy': 'returnPolicy',
                    'privacy_policy': 'privacyPolicy'
                };

                Object.keys(fieldMap).forEach(dbKey => {
                    const formKey = fieldMap[dbKey];
                    const input = form.querySelector(`[name="${formKey}"]`);
                    if (!input || settings[dbKey] === undefined) return;

                    if (input.type === 'checkbox') {
                        input.checked = !!settings[dbKey];
                    } else {
                        input.value = settings[dbKey] || '';
                    }
                });

                const sizesInput = form.querySelector('[name="sizesList"]');
                if (sizesInput) {
                    sizesInput.value = normalizeSizesList(settings.sizes_list).join(', ');
                }

                loadColorPalette(settings.color_palette);
                updateLogoIconPreviewFromUrl();
            } catch (error) {
                console.error('Failed to load settings:', error);
                Components.showToast('Ошибка', 'Не удалось загрузить настройки', 'error');
                loadColorPalette(null);
            }
        }

        const defaultPalette = [
            { name: 'Black', hex: '#2D2D2D' },
            { name: 'White', hex: '#FFFFFF' },
            { name: 'Beige', hex: '#D4C4B0' },
            { name: 'Navy', hex: '#1A2B4A' },
            { name: 'Grey', hex: '#8B8B8B' },
            { name: 'Brown', hex: '#6B4423' }
        ];

        const defaultSizes = ['XS', 'S', 'M', 'L', 'XL'];

        let paletteState = [...defaultPalette];

        function normalizePalette(value) {
            if (!value) return [...defaultPalette];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultPalette];
                const cleaned = parsed
                    .filter(item => item && item.name)
                    .map(item => ({
                        name: String(item.name).trim(),
                        hex: String(item.hex || '').trim() || '#CCCCCC'
                    }))
                    .filter(item => item.name.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultPalette];
            } catch (error) {
                return [...defaultPalette];
            }
        }

        function normalizeSizesList(value) {
            if (!value) return [...defaultSizes];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultSizes];
                const cleaned = parsed
                    .map(item => String(item).trim())
                    .filter(item => item.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultSizes];
            } catch (error) {
                return [...defaultSizes];
            }
        }

        function parseSizesInput(value) {
            return value
                .split(',')
                .map(item => item.trim())
                .filter(item => item.length > 0);
        }

        function updatePaletteValue() {
            const input = document.getElementById('colorPaletteValue');
            if (input) {
                input.value = JSON.stringify(paletteState);
            }
        }

        function renderPaletteList() {
            const container = document.getElementById('colorPaletteList');
            if (!container) return;

            container.innerHTML = paletteState.map((item, index) => `
                <div class="color-palette-row" data-index="${index}">
                    <input type="text" class="form-input" data-field="name" value="${item.name}" placeholder="Название">
                    <input type="color" class="form-input color-input" data-field="hex" value="${item.hex}">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="remove">Удалить</button>
                </div>
            `).join('');

            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const row = event.target.closest('.color-palette-row');
                    const index = parseInt(row.dataset.index, 10);
                    const field = event.target.dataset.field;
                    paletteState[index][field] = event.target.value.trim();
                    updatePaletteValue();
                });
            });

            container.querySelectorAll('[data-action="remove"]').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const row = event.target.closest('.color-palette-row');
                    const index = parseInt(row.dataset.index, 10);
                    paletteState.splice(index, 1);
                    if (paletteState.length === 0) {
                        paletteState = [...defaultPalette];
                    }
                    renderPaletteList();
                    updatePaletteValue();
                });
            });

            updatePaletteValue();
        }

        function loadColorPalette(value) {
            paletteState = normalizePalette(value);
            renderPaletteList();
        }

        document.getElementById('addColorBtn')?.addEventListener('click', () => {
            paletteState.push({ name: '', hex: '#CCCCCC' });
            renderPaletteList();
        });

        document.getElementById('logoIconFileBtn')?.addEventListener('click', () => {
            document.getElementById('logoIconFile')?.click();
        });

        document.getElementById('logoIconFile')?.addEventListener('change', async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            const status = document.getElementById('logoIconUploadStatus');
            status.textContent = 'Загрузка файла...';
            updateLogoIconPreviewFromFile(file);

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/api/uploads/logo', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const payload = await response.json().catch(() => ({}));
                if (!response.ok || !payload.url) {
                    throw new Error(payload.message || 'Не удалось загрузить файл');
                }

                document.getElementById('logoIcon').value = payload.url;
                status.textContent = 'Файл загружен.';
                updateLogoIconPreviewFromUrl();
            } catch (error) {
                console.error('Logo upload failed:', error);
                status.textContent = 'Не удалось загрузить файл.';
                Components.showToast('Ошибка', 'Не удалось загрузить favicon', 'error');
            }
        });

        function updateLogoIconPreviewFromFile(file) {
            const name = document.getElementById('logoIconFileName');
            const preview = document.getElementById('logoIconPreview');
            if (name) name.textContent = file?.name || 'Файл не выбран';
            if (!preview || !file) return;

            const url = URL.createObjectURL(file);
            preview.innerHTML = `<img src="${url}" alt="favicon preview">`;
            preview.querySelector('img')?.addEventListener('load', () => URL.revokeObjectURL(url));
        }

        function updateLogoIconPreviewFromUrl() {
            const url = document.getElementById('logoIcon')?.value?.trim();
            const name = document.getElementById('logoIconFileName');
            const preview = document.getElementById('logoIconPreview');
            if (!preview) return;

            if (url) {
                if (name) name.textContent = 'Используется файл';
                preview.innerHTML = `<img src="${url}" alt="favicon">`;
            } else {
                if (name) name.textContent = 'Файл не выбран';
                preview.innerHTML = '<div class="file-preview-empty">Превью favicon</div>';
            }
        }

        async function saveSettings() {
            try {
                const form = document.getElementById('settings-form');
                const formData = new FormData(form);
                const settings = {};

                for (let [key, value] of formData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input.type === 'checkbox') {
                        settings[key] = input.checked;
                    } else if (input.type === 'number') {
                        settings[key] = parseFloat(value) || 0;
                    } else {
                        settings[key] = value;
                    }
                }

                updatePaletteValue();
                settings.colorPalette = document.getElementById('colorPaletteValue')?.value || '';
                settings.sizesList = JSON.stringify(parseSizesInput(settings.sizesList || ''));

                await API.settings.update(settings);
                Components.showToast('Успешно', 'Настройки сохранены', 'success');

                // Reload settings to update formatPrice
                await loadSettings();
                if (window.Components && typeof Components.applyAdminBranding === 'function') {
                    Components.applyAdminBranding();
                }
            } catch (error) {
                console.error('Failed to save settings:', error);
                Components.showToast('Ошибка', 'Не удалось сохранить настройки', 'error');
            }
        }

        async function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword')?.value || '';
            const newPassword = document.getElementById('newPassword')?.value || '';
            const confirmPassword = document.getElementById('confirmPassword')?.value || '';

            if (!currentPassword || !newPassword || !confirmPassword) {
                Components.showToast('Ошибка', 'Заполните все поля пароля', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                Components.showToast('Ошибка', 'Пароли не совпадают', 'error');
                return;
            }

            try {
                await API.auth.changePassword(currentPassword, newPassword, confirmPassword);
                Components.showToast('Успешно', 'Пароль обновлен', 'success');
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                const message = error?.message || 'Не удалось обновить пароль';
                Components.showToast('Ошибка', message, 'error');
            }
        }


        let latestCleanupResult = null;

        async function runUploadsCleanup() {
            Components.confirm(
                'Очистить неиспользуемые файлы?',
                'Будут удалены изображения товаров и баннеров, не привязанные к базе данных.',
                async () => {
                    const button = document.getElementById('cleanupUploadsBtn');
                    const buttonText = button?.querySelector('.btn-text');
                    const type = document.getElementById('cleanupUploadsType')?.value || 'all';
                    if (button) {
                        button.disabled = true;
                        button.classList.add('btn-loading');
                    }
                    if (buttonText) buttonText.textContent = 'Очистка...';
                    try {
                        const response = await fetch('/api/uploads/cleanup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ type })
                        });

                        const payload = await response.json().catch(() => ({}));
                        if (!response.ok || !payload.success) {
                            throw new Error(payload.message || 'Не удалось выполнить очистку');
                        }

                        const products = payload.result?.products;
                        const banners = payload.result?.banners;
                        const productsText = products
                            ? `товары ${products.removed ?? 0}/${products.scanned ?? 0}`
                            : null;
                        const bannersText = banners
                            ? `баннеры ${banners.removed ?? 0}/${banners.scanned ?? 0}`
                            : null;
                        const details = [productsText, bannersText].filter(Boolean).join(', ');
                        const message = details ? `Удалено: ${details}` : 'Очистка завершена.';

                        Components.showToast('Успешно', message, 'success');
                        showCleanupDetailsModal(payload.result || {});
                    } catch (error) {
                        console.error('Cleanup failed:', error);
                        Components.showToast('Ошибка', error.message || 'Не удалось выполнить очистку', 'error');
                    } finally {
                        if (button) {
                            button.disabled = false;
                            button.classList.remove('btn-loading');
                        }
                        if (buttonText) buttonText.textContent = 'Очистить неиспользуемые';
                    }
                }
            );
        }

        function showCleanupDetailsModal(result) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            latestCleanupResult = result;

            const listLimit = 5;

            const renderSection = (title, data) => {
                if (!data) return '';
                const removedUrls = Array.isArray(data.removedUrls) ? data.removedUrls : [];
                const visibleUrls = removedUrls.slice(0, listLimit);
                const hiddenCount = Math.max(removedUrls.length - visibleUrls.length, 0);
                const removedItems = removedUrls.length
                    ? `<ul class="cleanup-list">${visibleUrls.map(url => `<li>${url}</li>`).join('')}</ul>`
                    : '<div class="cleanup-empty">Ничего не удалено.</div>';
                const moreInfo = hiddenCount > 0
                    ? `<div class="cleanup-more">И еще ${hiddenCount}</div>`
                    : '';

                return `
                    <div class="cleanup-section">
                        <h4>${title}</h4>
                        <div class="cleanup-meta">Удалено: ${data.removed ?? 0} из ${data.scanned ?? 0}</div>
                        ${removedItems}
                        ${moreInfo}
                    </div>
                `;
            };

            const bodyHtml = `
                ${renderSection('Товары', result.products)}
                ${renderSection('Баннеры', result.banners)}
            `;

            modal.innerHTML = `
                <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                <div class="modal-dialog modal-dialog-lg">
                    <div class="modal-header">
                        <h3 class="modal-title">Детали очистки</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">Закрыть</button>
                    </div>
                    <div class="modal-body">
                        ${bodyHtml}
                    </div>
                    <div class="modal-footer">
                        <div class="cleanup-actions">
                            <button class="btn btn-ghost" onclick="copyCleanupList()">Скопировать список</button>
                            <button class="btn btn-ghost" onclick="downloadCleanupCsv()">Скачать CSV</button>
                        </div>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Закрыть</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function collectCleanupUrls(result) {
            const items = [];
            const products = Array.isArray(result?.products?.removedUrls) ? result.products.removedUrls : [];
            const banners = Array.isArray(result?.banners?.removedUrls) ? result.banners.removedUrls : [];

            products.forEach(url => items.push({ type: 'products', url }));
            banners.forEach(url => items.push({ type: 'banners', url }));

            return items;
        }

        async function copyCleanupList() {
            const items = collectCleanupUrls(latestCleanupResult || {});
            if (items.length === 0) {
                Components.showToast('Инфо', 'Нет удаленных файлов для копирования', 'info');
                return;
            }

            const text = items.map(item => `${item.type}\t${item.url}`).join('\n');
            try {
                if (navigator?.clipboard?.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    textarea.setAttribute('readonly', '');
                    textarea.style.position = 'absolute';
                    textarea.style.left = '-9999px';
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    textarea.remove();
                }
                Components.showToast('Успешно', 'Список скопирован', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                Components.showToast('Ошибка', 'Не удалось скопировать список', 'error');
            }
        }

        function downloadCleanupCsv() {
            const items = collectCleanupUrls(latestCleanupResult || {});
            if (items.length === 0) {
                Components.showToast('Инфо', 'Нет удаленных файлов для экспорта', 'info');
                return;
            }

            const header = 'type,url';
            const rows = items.map(item => `${item.type},"${String(item.url).replace(/"/g, '""')}"`);
            const csv = [header, ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `uploads-cleanup-${Date.now()}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>

</html>