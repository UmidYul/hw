<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ - AURA Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h1>
                        <p class="page-subtitle">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∞–≥–∞–∑–∏–Ω–∞</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üì§
                            –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                        <input type="file" id="import-file" accept=".json" style="display:none"
                            onchange="importData(event)">
                        <button class="btn btn-error" onclick="resetData()">üóëÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                    </div>
                </div>

                <form id="settings-form">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞</label>
                                    <input type="text" class="form-input" name="storeName">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–õ–æ–≥–æ—Ç–∏–ø (—Ç–µ–∫—Å—Ç)</label>
                                    <input type="text" class="form-input" name="logoText">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea class="form-textarea" name="storeDescription" rows="3"></textarea>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" name="contactEmail">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="tel" class="form-input" name="contactPhone">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">–í–∞–ª—é—Ç–∞ –∏ —Ü–µ–Ω—ã</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">–í–∞–ª—é—Ç–∞</label>
                                    <select class="form-select" name="currency">
                                        <option value="RUB">–†—É–±–ª—å (RUB)</option>
                                        <option value="USD">–î–æ–ª–ª–∞—Ä (USD)</option>
                                        <option value="EUR">–ï–≤—Ä–æ (EUR)</option>
                                        <option value="UZS">–°—É–º (UZS)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–°–∏–º–≤–æ–ª –≤–∞–ª—é—Ç—ã</label>
                                    <input type="text" class="form-input" name="currencySymbol">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">–î–æ—Å—Ç–∞–≤–∫–∞</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –æ—Ç (‚ÇΩ)</label>
                                    <input type="number" class="form-input" name="freeShippingThreshold" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (‚ÇΩ)</label>
                                    <input type="number" class="form-input" name="flatShippingRate" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">–ù–∞–ª–æ–≥–∏</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="enableTaxes">
                                    <span>–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ª–æ–≥–∏</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">–ù–î–° (%)</label>
                                <input type="number" class="form-input" name="taxPercent" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">–ü–æ–ª–∏—Ç–∏–∫–∏</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">–ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                                <textarea class="form-textarea" name="returnPolicy" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</label>
                                <textarea class="form-textarea" name="privacyPolicy" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-lg">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        async function loadSettings() {
            try {
                const settings = await API.settings.get();
                const form = document.getElementById('settings-form');

                // Map database fields to form fields
                const fieldMap = {
                    'site_name': 'storeName',
                    'logo_text': 'logoText',
                    'store_description': 'storeDescription',
                    'contact_email': 'contactEmail',
                    'contact_phone': 'contactPhone',
                    'currency': 'currency',
                    'currency_symbol': 'currencySymbol',
                    'free_shipping_threshold': 'freeShippingThreshold',
                    'shipping_cost': 'flatShippingRate',
                    'enable_taxes': 'enableTaxes',
                    'vat_rate': 'taxPercent',
                    'return_policy': 'returnPolicy',
                    'privacy_policy': 'privacyPolicy'
                };

                Object.keys(fieldMap).forEach(dbKey => {
                    const formKey = fieldMap[dbKey];
                    const input = form.querySelector(`[name="${formKey}"]`);
                    if (!input || settings[dbKey] === undefined) return;

                    if (input.type === 'checkbox') {
                        input.checked = !!settings[dbKey];
                    } else {
                        input.value = settings[dbKey] || '';
                    }
                });
            } catch (error) {
                console.error('Failed to load settings:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'error');
            }
        }

        async function saveSettings() {
            try {
                const form = document.getElementById('settings-form');
                const formData = new FormData(form);
                const settings = {};

                for (let [key, value] of formData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input.type === 'checkbox') {
                        settings[key] = input.checked;
                    } else if (input.type === 'number') {
                        settings[key] = parseFloat(value) || 0;
                    } else {
                        settings[key] = value;
                    }
                }

                await API.settings.update(settings);
                Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');

                // Reload settings to update formatPrice
                await loadSettings();
            } catch (error) {
                console.error('Failed to save settings:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏', 'error');
            }
        }

        function exportData() {
            const data = REPO.exportData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aura-backup-${Date.now()}.json`;
            a.click();
            Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    REPO.importData(data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (err) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            Components.confirm(
                '–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?',
                '–≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã, –∑–∞–∫–∞–∑—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.',
                () => {
                    REPO.resetData();
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                }
            );
        }

        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>

</html>