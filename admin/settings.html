<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки - Higher Waist Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">Higher Waist Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Основное</div>
                    <a href="/admin" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Каталог</div>
                    <a href="/admin/products" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Товары</span>
                    </a>
                    <a href="/admin/categories" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Категории</span>
                    </a>
                    <a href="/admin/collections" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Коллекции</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Маркетинг</div>
                    <a href="/admin/discounts" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Скидки</span>
                    </a>
                    <a href="/admin/promocodes" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Промокоды</span>
                    </a>
                    <a href="/admin/banners" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Баннеры</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Продажи</div>
                    <a href="/admin/orders" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Заказы</span>
                    </a>
                    <a href="/admin/customers" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Клиенты</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Настройки</div>
                    <a href="/admin/settings" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon"></span>
                        <span>Настройки</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">Меню</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">Администратор</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Настройки</h1>
                        <p class="page-subtitle">Конфигурация магазина</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="exportData()">Экспорт данных</button>
                        <button class="btn btn-secondary"
                            onclick="document.getElementById('import-file').click()">Импорт данных</button>
                        <input type="file" id="import-file" accept=".json" style="display:none"
                            onchange="importData(event)">
                        <button class="btn btn-error" onclick="resetData()">Сбросить данные</button>
                    </div>
                </div>

                <form id="settings-form">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Основная информация</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Название магазина</label>
                                    <input type="text" class="form-input" name="storeName">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Логотип (текст)</label>
                                    <input type="text" class="form-input" name="logoText">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Описание</label>
                                <textarea class="form-textarea" name="storeDescription" rows="3"></textarea>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" name="contactEmail">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Телефон</label>
                                    <input type="tel" class="form-input" name="contactPhone">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Соцсети</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Instagram</label>
                                    <input type="url" class="form-input" name="socialInstagram"
                                        placeholder="https://instagram.com/...">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Facebook</label>
                                    <input type="url" class="form-input" name="socialFacebook"
                                        placeholder="https://facebook.com/...">
                                </div>
                            </div>

                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Telegram</label>
                                    <input type="url" class="form-input" name="socialTelegram"
                                        placeholder="https://t.me/...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Цветовая палитра</h3>
                        </div>
                        <div class="card-body">
                            <input type="hidden" name="colorPalette" id="colorPaletteValue">
                            <div class="color-palette-list" id="colorPaletteList"></div>
                            <button type="button" class="btn btn-secondary" id="addColorBtn">Добавить цвет</button>
                            <div class="form-hint">Используется в фильтрах и карточках товаров.</div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Размеры</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Список размеров (через запятую)</label>
                                <input type="text" class="form-input" name="sizesList" placeholder="XS, S, M, L, XL">
                                <div class="form-hint">Используется в таблице остатков по вариантам.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Доставка</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2">
                                <div class="form-group">
                                    <label class="form-label">Бесплатная доставка от (Сумм)</label>
                                    <input type="number" class="form-input" name="freeShippingThreshold" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Стоимость доставки (Сумм)</label>
                                    <input type="number" class="form-input" name="flatShippingRate" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Налоги</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="enableTaxes">
                                    <span>Включить налоги</span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label class="form-label">НДС (%)</label>
                                <input type="number" class="form-input" name="taxPercent" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="card mt-lg">
                        <div class="card-header">
                            <h3 class="card-title">Политики</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Политика возврата</label>
                                <textarea class="form-textarea" name="returnPolicy" rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Политика конфиденциальности</label>
                                <textarea class="form-textarea" name="privacyPolicy" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-lg">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()">Отмена</button>
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить
                            настройки</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        async function loadSettings() {
            try {
                const settings = await API.settings.get();
                const form = document.getElementById('settings-form');

                // Map database fields to form fields
                const fieldMap = {
                    'site_name': 'storeName',
                    'logo_text': 'logoText',
                    'store_description': 'storeDescription',
                    'contact_email': 'contactEmail',
                    'contact_phone': 'contactPhone',
                    'social_instagram': 'socialInstagram',
                    'social_facebook': 'socialFacebook',
                    'social_telegram': 'socialTelegram',
                    'color_palette': 'colorPalette',
                    'sizes_list': 'sizesList',
                    'free_shipping_threshold': 'freeShippingThreshold',
                    'shipping_cost': 'flatShippingRate',
                    'enable_taxes': 'enableTaxes',
                    'vat_rate': 'taxPercent',
                    'return_policy': 'returnPolicy',
                    'privacy_policy': 'privacyPolicy'
                };

                Object.keys(fieldMap).forEach(dbKey => {
                    const formKey = fieldMap[dbKey];
                    const input = form.querySelector(`[name="${formKey}"]`);
                    if (!input || settings[dbKey] === undefined) return;

                    if (input.type === 'checkbox') {
                        input.checked = !!settings[dbKey];
                    } else {
                        input.value = settings[dbKey] || '';
                    }
                });

                const sizesInput = form.querySelector('[name="sizesList"]');
                if (sizesInput) {
                    sizesInput.value = normalizeSizesList(settings.sizes_list).join(', ');
                }

                loadColorPalette(settings.color_palette);
            } catch (error) {
                console.error('Failed to load settings:', error);
                Components.showToast('Ошибка', 'Не удалось загрузить настройки', 'error');
                loadColorPalette(null);
            }
        }

        const defaultPalette = [
            { name: 'Black', hex: '#2D2D2D' },
            { name: 'White', hex: '#FFFFFF' },
            { name: 'Beige', hex: '#D4C4B0' },
            { name: 'Navy', hex: '#1A2B4A' },
            { name: 'Grey', hex: '#8B8B8B' },
            { name: 'Brown', hex: '#6B4423' }
        ];

        const defaultSizes = ['XS', 'S', 'M', 'L', 'XL'];

        let paletteState = [...defaultPalette];

        function normalizePalette(value) {
            if (!value) return [...defaultPalette];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultPalette];
                const cleaned = parsed
                    .filter(item => item && item.name)
                    .map(item => ({
                        name: String(item.name).trim(),
                        hex: String(item.hex || '').trim() || '#CCCCCC'
                    }))
                    .filter(item => item.name.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultPalette];
            } catch (error) {
                return [...defaultPalette];
            }
        }

        function normalizeSizesList(value) {
            if (!value) return [...defaultSizes];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultSizes];
                const cleaned = parsed
                    .map(item => String(item).trim())
                    .filter(item => item.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultSizes];
            } catch (error) {
                return [...defaultSizes];
            }
        }

        function parseSizesInput(value) {
            return value
                .split(',')
                .map(item => item.trim())
                .filter(item => item.length > 0);
        }

        function updatePaletteValue() {
            const input = document.getElementById('colorPaletteValue');
            if (input) {
                input.value = JSON.stringify(paletteState);
            }
        }

        function renderPaletteList() {
            const container = document.getElementById('colorPaletteList');
            if (!container) return;

            container.innerHTML = paletteState.map((item, index) => `
                <div class="color-palette-row" data-index="${index}">
                    <input type="text" class="form-input" data-field="name" value="${item.name}" placeholder="Название">
                    <input type="color" class="form-input color-input" data-field="hex" value="${item.hex}">
                    <button type="button" class="btn btn-ghost btn-sm" data-action="remove">Удалить</button>
                </div>
            `).join('');

            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (event) => {
                    const row = event.target.closest('.color-palette-row');
                    const index = parseInt(row.dataset.index, 10);
                    const field = event.target.dataset.field;
                    paletteState[index][field] = event.target.value.trim();
                    updatePaletteValue();
                });
            });

            container.querySelectorAll('[data-action="remove"]').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const row = event.target.closest('.color-palette-row');
                    const index = parseInt(row.dataset.index, 10);
                    paletteState.splice(index, 1);
                    if (paletteState.length === 0) {
                        paletteState = [...defaultPalette];
                    }
                    renderPaletteList();
                    updatePaletteValue();
                });
            });

            updatePaletteValue();
        }

        function loadColorPalette(value) {
            paletteState = normalizePalette(value);
            renderPaletteList();
        }

        document.getElementById('addColorBtn')?.addEventListener('click', () => {
            paletteState.push({ name: '', hex: '#CCCCCC' });
            renderPaletteList();
        });

        async function saveSettings() {
            try {
                const form = document.getElementById('settings-form');
                const formData = new FormData(form);
                const settings = {};

                for (let [key, value] of formData.entries()) {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input.type === 'checkbox') {
                        settings[key] = input.checked;
                    } else if (input.type === 'number') {
                        settings[key] = parseFloat(value) || 0;
                    } else {
                        settings[key] = value;
                    }
                }

                updatePaletteValue();
                settings.colorPalette = document.getElementById('colorPaletteValue')?.value || '';
                settings.sizesList = JSON.stringify(parseSizesInput(settings.sizesList || ''));

                await API.settings.update(settings);
                Components.showToast('Успешно', 'Настройки сохранены', 'success');

                // Reload settings to update formatPrice
                await loadSettings();
            } catch (error) {
                console.error('Failed to save settings:', error);
                Components.showToast('Ошибка', 'Не удалось сохранить настройки', 'error');
            }
        }

        function exportData() {
            const data = REPO.exportData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Higher Waist-backup-${Date.now()}.json`;
            a.click();
            Components.showToast('Успешно', 'Данные экспортированы', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    REPO.importData(data);
                    Components.showToast('Успешно', 'Данные импортированы', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } catch (err) {
                    Components.showToast('Ошибка', 'Неверный формат файла', 'error');
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            Components.confirm(
                'Сбросить все данные?',
                'Это удалит все товары, заказы и настройки. Демо-данные будут восстановлены.',
                () => {
                    REPO.resetData();
                    Components.showToast('Успешно', 'Данные сброшены', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                }
            );
        }

        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>

</html>