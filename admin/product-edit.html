<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞ - AURA Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" onclick="window.history.back()">‚Üê –ù–∞–∑–∞–¥</button>
                </div>
                <div class="topbar-right">
                    <button class="btn btn-secondary" onclick="saveDraft()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
                    <button class="btn btn-primary" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </header>

            <div class="page-content">
                <h1 class="page-title" id="page-title">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h1>

                <div class="tabs">
                    <button class="tab active" data-tab="basic">–û—Å–Ω–æ–≤–Ω–æ–µ</button>
                    <button class="tab" data-tab="pricing">–¶–µ–Ω—ã</button>
                    <button class="tab" data-tab="inventory">–û—Å—Ç–∞—Ç–∫–∏</button>
                    <button class="tab" data-tab="description">–û–ø–∏—Å–∞–Ω–∏–µ</button>
                </div>

                <form id="product-form">
                    <!-- Tab: Basic -->
                    <div class="tab-content active" id="tab-basic">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label form-label-required">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                                    <input type="text" class="form-input" name="title" required>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                        <select class="form-select" name="category">
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                        <select class="form-select" name="status">
                                            <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                                            <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                                            <option value="archived">–ê—Ä—Ö–∏–≤</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">–¢–µ–≥–∏</label>
                                        <div class="flex gap-md">
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="New">
                                                <span>New</span>
                                            </label>
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="Sale">
                                                <span>Sale</span>
                                            </label>
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="Limited">
                                                <span>Limited</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Pricing -->
                    <div class="tab-content" id="tab-pricing">
                        <div class="card">
                            <div class="card-body">
                                <div class="grid grid-cols-3">
                                    <div class="form-group">
                                        <label class="form-label form-label-required">–¶–µ–Ω–∞</label>
                                        <input type="number" class="form-input" name="price" required min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label>
                                        <input type="number" class="form-input" name="oldPrice" min="0">
                                        <div class="form-hint">–î–ª—è —Å–∫–∏–¥–æ–∫</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                                        <input type="number" class="form-input" name="cost" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Inventory -->
                    <div class="tab-content" id="tab-inventory">
                        <div class="card">
                            <div class="card-body">
                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">–û—Å—Ç–∞—Ç–æ–∫</label>
                                        <input type="number" class="form-input" name="stock" value="0" min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">–ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞</label>
                                        <input type="number" class="form-input" name="lowStockThreshold" value="5"
                                            min="0">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–¶–≤–µ—Ç–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                                    <input type="text" class="form-input" name="colors"
                                        placeholder="Black, White, Grey">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                                    <input type="text" class="form-input" name="sizes" placeholder="XS, S, M, L, XL">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º</label>
                                    <div id="variants-matrix" class="variants-matrix"></div>
                                    <div class="form-hint">–£–∫–∞–∂–∏—Ç–µ –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ü–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Description -->
                    <div class="tab-content" id="tab-description">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <input type="text" class="form-input" name="shortDescription">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                                    <textarea class="form-textarea" name="fullDescription" rows="4"></textarea>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
                                        <input type="text" class="form-input" name="material">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">–£—Ö–æ–¥</label>
                                        <input type="text" class="form-input" name="care">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞</label>
                                    <div id="product-images-container" class="product-images-container">
                                        <!-- Images will be rendered here -->
                                    </div>
                                    <div class="flex gap-md" style="margin-top: 12px;">
                                        <input type="url" class="form-input" id="new-image-url"
                                            placeholder="https://..." style="flex: 1;">
                                        <button type="button" class="btn btn-secondary" onclick="addImage()">‚ûï –î–æ–±–∞–≤–∏—Ç—å
                                            —Ñ–æ—Ç–æ</button>
                                    </div>
                                    <div class="form-hint">–î–æ–±–∞–≤—å—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–æ–≤–∞—Ä–∞. –ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç
                                        –≥–ª–∞–≤–Ω—ã–º.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/repo.js"></script>
    <script src="/admin/seed.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        let editingId = null;
        let allCategories = [];
        let productImages = [];

        async function loadCategories() {
            try {
                allCategories = await API.categories.getAll();
                const select = document.querySelector('select[name="category"]');
                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.slug || cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
                // Fallback to REPO
                const categories = REPO.getCategories();
                const select = document.querySelector('select[name="category"]');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }
        }

        // Image Gallery Functions
        function renderImages() {
            const container = document.getElementById('product-images-container');

            if (productImages.length === 0) {
                container.innerHTML = '<div class="product-image-placeholder">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞.</div>';
                return;
            }

            container.innerHTML = productImages.map((url, index) => `
                <div class="product-image-item" draggable="true" data-index="${index}">
                    ${index === 0 ? '<div class="product-image-badge">–ì–ª–∞–≤–Ω–æ–µ</div>' : ''}
                    <button class="product-image-remove" onclick="removeImage(${index})" type="button">‚úï</button>
                    <img src="${url}" alt="Product ${index + 1}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"120\" height=\"120\" viewBox=\"0 0 120 120\"><rect width=\"120\" height=\"120\" fill=\"%23f0f0f0\"/><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dominant-baseline=\"middle\" font-family=\"Arial\" font-size=\"12\" fill=\"%23999\">No image</text></svg>'">
                </div>
            `).join('');

            // Add drag-and-drop functionality
            const items = container.querySelectorAll('.product-image-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function addImage() {
            const input = document.getElementById('new-image-url');
            const url = input.value.trim();

            if (!url) {
                Components.showToast('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                Components.showToast('–û—à–∏–±–∫–∞', 'URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://', 'error');
                return;
            }

            productImages.push(url);
            input.value = '';
            renderImages();
            Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
        }

        function removeImage(index) {
            Components.confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?', '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', () => {
                productImages.splice(index, 1);
                renderImages();
                Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            });
        }

        // Drag and Drop handlers
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.currentTarget.dataset.index);

            if (draggedIndex !== dropIndex) {
                const draggedItem = productImages[draggedIndex];
                productImages.splice(draggedIndex, 1);
                productImages.splice(dropIndex, 0, draggedItem);
                renderImages();
            }

            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            draggedIndex = null;
        }

        function parseListInput(value) {
            return value
                .split(',')
                .map(item => item.trim())
                .filter(item => item.length > 0);
        }

        function getVariantsFromMatrix() {
            return Array.from(document.querySelectorAll('.variants-input')).map(input => ({
                color: input.dataset.color,
                size: input.dataset.size,
                stock: parseInt(input.value, 10) || 0
            }));
        }

        function renderVariantsMatrix(colors, sizes, variants = []) {
            const container = document.getElementById('variants-matrix');

            if (!colors.length || !sizes.length) {
                container.innerHTML = '<div class="form-hint">–î–æ–±–∞–≤—å—Ç–µ —Ü–≤–µ—Ç–∞ –∏ —Ä–∞–∑–º–µ—Ä—ã, —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏.</div>';
                return;
            }

            const variantMap = new Map();
            variants.forEach(v => {
                const key = `${v.color}||${v.size}`;
                variantMap.set(key, Math.max(0, parseInt(v.stock, 10) || 0));
            });

            let html = '<div class="variants-table">';
            html += '<div class="variants-row">';
            html += '<div class="variants-cell variants-cell-head"></div>';
            html += sizes.map(size => `<div class="variants-cell variants-cell-head">${size}</div>`).join('');
            html += '</div>';

            colors.forEach(color => {
                html += '<div class="variants-row">';
                html += `<div class="variants-cell variants-cell-head">${color}</div>`;
                sizes.forEach(size => {
                    const key = `${color}||${size}`;
                    const stock = variantMap.has(key) ? variantMap.get(key) : 0;
                    html += `
                        <div class="variants-cell">
                            <input type="number" class="variants-input" data-color="${color}" data-size="${size}" min="0" value="${stock}">
                        </div>
                    `;
                });
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function initializeVariantsMatrix() {
            const colorsInput = document.querySelector('[name="colors"]');
            const sizesInput = document.querySelector('[name="sizes"]');

            const updateMatrix = () => {
                const colors = parseListInput(colorsInput.value);
                const sizes = parseListInput(sizesInput.value);
                const existingVariants = getVariantsFromMatrix();
                renderVariantsMatrix(colors, sizes, existingVariants);
            };

            colorsInput.addEventListener('input', updateMatrix);
            sizesInput.addEventListener('input', updateMatrix);

            updateMatrix();
        }

        // Allow Enter key to add image
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('new-image-url');
            if (imageInput) {
                imageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addImage();
                    }
                });
            }
        });

        async function loadProduct() {
            const params = new URLSearchParams(window.location.search);
            editingId = params.get('id');

            if (!editingId) {
                renderImages();
                return;
            }

            try {
                const product = await API.products.getById(editingId);
                if (!product) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }
                fillForm(product);
            } catch (error) {
                console.error('Failed to load product:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
            }
        }

        function fillForm(product) {

            document.getElementById('page-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ' + product.title;

            const form = document.getElementById('product-form');
            const images = Array.isArray(product.images) ? product.images : (product.images ? JSON.parse(product.images) : []);
            const colors = Array.isArray(product.colors) ? product.colors : (product.colors ? JSON.parse(product.colors) : []);
            const sizes = Array.isArray(product.sizes) ? product.sizes : (product.sizes ? JSON.parse(product.sizes) : []);

            // Load images
            productImages = images.length > 0 ? images : [];
            renderImages();

            form.querySelector('[name="title"]').value = product.title;
            form.querySelector('[name="category"]').value = product.category;
            form.querySelector('[name="status"]').value = product.status;
            form.querySelector('[name="price"]').value = product.price;
            form.querySelector('[name="oldPrice"]').value = product.oldPrice || product.old_price || '';
            form.querySelector('[name="cost"]').value = product.cost || '';
            form.querySelector('[name="stock"]').value = product.stock;
            form.querySelector('[name="lowStockThreshold"]').value = product.lowStockThreshold || product.low_stock_threshold || 10;
            form.querySelector('[name="shortDescription"]').value = product.shortDescription || product.short_description || product.description || '';
            form.querySelector('[name="fullDescription"]').value = product.fullDescription || product.full_description || product.description || '';
            form.querySelector('[name="material"]').value = product.material || '';
            form.querySelector('[name="care"]').value = product.care || '';

            if (colors && colors.length > 0) {
                form.querySelector('[name="colors"]').value = colors.join(', ');
            }
            if (sizes && sizes.length > 0) {
                form.querySelector('[name="sizes"]').value = product.sizes.join(', ');
            }

            renderVariantsMatrix(colors, sizes, product.variants || []);
            initializeVariantsMatrix();

            // Tags
            if (product.tags) {
                product.tags.forEach(tag => {
                    const checkbox = form.querySelector(`[name="tags"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        function getFormData() {
            const form = document.getElementById('product-form');
            const data = {
                title: form.querySelector('[name="title"]').value,
                category: form.querySelector('[name="category"]').value,
                status: form.querySelector('[name="status"]').value,
                price: parseInt(form.querySelector('[name="price"]').value) || 0,
                oldPrice: parseInt(form.querySelector('[name="oldPrice"]').value) || null,
                cost: parseInt(form.querySelector('[name="cost"]').value) || null,
                stock: parseInt(form.querySelector('[name="stock"]').value) || 0,
                lowStockThreshold: parseInt(form.querySelector('[name="lowStockThreshold"]').value) || 5,
                shortDescription: form.querySelector('[name="shortDescription"]').value,
                fullDescription: form.querySelector('[name="fullDescription"]').value,
                description: form.querySelector('[name="fullDescription"]').value || form.querySelector('[name="shortDescription"]').value,
                material: form.querySelector('[name="material"]').value,
                care: form.querySelector('[name="care"]').value,
                fit: 'Regular fit',
                rating: 0,
                reviewsCount: 0
            };

            // Tags
            const tagCheckboxes = form.querySelectorAll('[name="tags"]:checked');
            data.tags = Array.from(tagCheckboxes).map(cb => cb.value);

            // Colors
            const colorsInput = form.querySelector('[name="colors"]').value;
            data.colors = colorsInput ? colorsInput.split(',').map(c => c.trim()) : [];

            // Sizes
            const sizesInput = form.querySelector('[name="sizes"]').value;
            data.sizes = sizesInput ? sizesInput.split(',').map(s => s.trim()) : [];

            // Variants
            const variants = getVariantsFromMatrix();
            if (variants.length > 0) {
                data.variants = variants;
                data.stock = variants.reduce((sum, v) => sum + v.stock, 0);
            }

            // Images from gallery
            data.images = productImages.length > 0 ? productImages : ['https://via.placeholder.com/400'];

            return data;
        }

        function validateForm() {
            const data = getFormData();

            if (!data.title) {
                Components.showToast('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞', 'error');
                return false;
            }

            if (data.price <= 0) {
                Components.showToast('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É', 'error');
                return false;
            }

            return true;
        }

        async function saveProduct() {
            if (!validateForm()) return;

            const data = getFormData();
            data.status = 'active';

            try {
                if (editingId) {
                    await API.products.update(editingId, data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                } else {
                    await API.products.create(data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω', 'success');
                }

                setTimeout(() => {
                    window.location.href = 'products.html';
                }, 500);
            } catch (error) {
                console.error('Failed to save product:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
            }
        }

        async function saveDraft() {
            if (!validateForm()) return;

            const data = getFormData();
            data.status = 'draft';

            try {
                if (editingId) {
                    await API.products.update(editingId, data);
                } else {
                    await API.products.create(data);
                }

                Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            } catch (error) {
                console.error('Failed to save draft:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫', 'error');
            }
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            await loadProduct();
            if (!editingId) {
                initializeVariantsMatrix();
            }
        });
    </script>
</body>

</html>