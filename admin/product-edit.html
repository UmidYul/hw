<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактор товара - Higher Waist Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-text">Higher Waist Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Основное</div>
                    <a href="/admin" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Каталог</div>
                    <a href="/admin/products" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon"></span>
                        <span>Товары</span>
                    </a>
                    <a href="/admin/categories" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Категории</span>
                    </a>
                    <a href="/admin/collections" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Коллекции</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Маркетинг</div>
                    <a href="/admin/discounts" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Скидки</span>
                    </a>
                    <a href="/admin/promocodes" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Промокоды</span>
                    </a>
                    <a href="/admin/banners" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Баннеры</span>
                    </a>
                    <a href="/admin/newsletters" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Рассылки</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Продажи</div>
                    <a href="/admin/orders" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Заказы</span>
                    </a>
                    <a href="/admin/customers" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Клиенты</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Контент</div>
                    <a href="/admin/pages" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Страницы</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Настройки</div>
                    <a href="/admin/settings" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Настройки</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" onclick="handleBackNavigation()">← Назад</button>
                </div>
                <div class="topbar-right">
                    <button class="btn btn-secondary" onclick="saveDraft()">Сохранить черновик</button>
                    <button class="btn btn-primary" onclick="saveProduct()">Сохранить и опубликовать</button>
                </div>
            </header>

            <div class="page-content">
                <h1 class="page-title" id="page-title">Новый товар</h1>

                <div class="tabs">
                    <button class="tab active" data-tab="basic">Основное</button>
                    <button class="tab" data-tab="pricing">Цены</button>
                    <button class="tab" data-tab="inventory">Остатки</button>
                    <button class="tab" data-tab="description">Описание</button>
                </div>

                <form id="product-form">
                    <!-- Tab: Basic -->
                    <div class="tab-content active" id="tab-basic">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label form-label-required">Название</label>
                                    <input type="text" class="form-input" name="title" required>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Категория</label>
                                        <select class="form-select" name="category">
                                            <option value="">Выберите категорию</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Статус</label>
                                        <select class="form-select" name="status">
                                            <option value="draft">Черновик</option>
                                            <option value="active">Активен</option>
                                            <option value="archived">Архив</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Теги</label>
                                        <div class="flex gap-md">
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="New">
                                                <span>New</span>
                                            </label>
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="Sale">
                                                <span>Sale</span>
                                            </label>
                                            <label class="form-checkbox">
                                                <input type="checkbox" name="tags" value="Limited">
                                                <span>Limited</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Pricing -->
                    <div class="tab-content" id="tab-pricing">
                        <div class="card">
                            <div class="card-body">
                                <div class="grid grid-cols-3">
                                    <div class="form-group">
                                        <label class="form-label form-label-required">Цена</label>
                                        <input type="number" class="form-input" name="price" required min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Старая цена</label>
                                        <input type="number" class="form-input" name="oldPrice" min="0">
                                        <div class="form-hint">Для скидок</div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Себестоимость</label>
                                        <input type="number" class="form-input" name="cost" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Inventory -->
                    <div class="tab-content" id="tab-inventory">
                        <div class="card">
                            <div class="card-body">
                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Остаток</label>
                                        <input type="number" class="form-input" name="stock" value="0" min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Порог низкого остатка</label>
                                        <input type="number" class="form-input" name="lowStockThreshold" value="5"
                                            min="0">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Остатки по вариантам</label>
                                    <div id="variants-matrix" class="variants-matrix"></div>
                                    <div class="form-hint">Цвета и размеры берутся из настроек магазина.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Description -->
                    <div class="tab-content" id="tab-description">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Краткое описание</label>
                                    <input type="text" class="form-input" name="shortDescription">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Полное описание</label>
                                    <textarea class="form-textarea" name="fullDescription" rows="4"></textarea>
                                </div>

                                <div class="grid grid-cols-2">
                                    <div class="form-group">
                                        <label class="form-label">Материал</label>
                                        <input type="text" class="form-input" name="material">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Уход</label>
                                        <input type="text" class="form-input" name="care">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Изображения товара</label>
                                    <div id="product-images-container" class="product-images-container">
                                        <!-- Images will be rendered here -->
                                    </div>
                                    <div class="flex gap-md" style="margin-top: 12px;">
                                        <input type="url" class="form-input" id="new-image-url"
                                            placeholder="https://..." style="flex: 1;">
                                        <button type="button" class="btn btn-secondary" onclick="addImage()">Добавить
                                            по ссылке</button>
                                    </div>
                                    <div class="flex gap-md" style="margin-top: 12px;">
                                        <input type="file" class="form-input" id="new-image-file" accept="image/*"
                                            style="flex: 1;">
                                        <button type="button" class="btn btn-secondary" onclick="uploadImageFile()">
                                            Загрузить файл
                                        </button>
                                    </div>
                                    <div class="form-hint">Добавьте несколько фотографий товара. Первое фото будет
                                        главным.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        let editingId = null;
        let allCategories = [];
        let productImages = [];
        const sessionUploadedImages = new Set();
        let paletteColors = [];
        let settingsSizes = [];

        async function loadCategories() {
            try {
                allCategories = await API.categories.getAll();
                const select = document.querySelector('select[name="category"]');
                allCategories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.slug || cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
                allCategories = [];
                Components.showToast('Ошибка', 'Не удалось загрузить категории', 'error');
            }
        }

        // Image Gallery Functions
        function renderImages() {
            const container = document.getElementById('product-images-container');

            if (productImages.length === 0) {
                container.innerHTML = '<div class="product-image-placeholder">Нет изображений. Добавьте фото товара.</div>';
                return;
            }

            container.innerHTML = productImages.map((url, index) => `
                <div class="product-image-item" draggable="true" data-index="${index}">
                    ${index === 0 ? '<div class="product-image-badge">Главное</div>' : ''}
                    <button class="product-image-remove" onclick="removeImage(${index})" type="button">Удалить</button>
                    <img src="${url}" alt="Product ${index + 1}" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"120\" height=\"120\" viewBox=\"0 0 120 120\"><rect width=\"120\" height=\"120\" fill=\"%23f0f0f0\"/><text x=\"50%\" y=\"50%\" text-anchor=\"middle\" dominant-baseline=\"middle\" font-family=\"Arial\" font-size=\"12\" fill=\"%23999\">No image</text></svg>'">
                </div>
            `).join('');

            // Add drag-and-drop functionality
            const items = container.querySelectorAll('.product-image-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function addImage() {
            const input = document.getElementById('new-image-url');
            const url = input.value.trim();

            if (!url) {
                Components.showToast('Ошибка', 'Введите URL изображения', 'error');
                return;
            }

            const isRemote = url.startsWith('http://') || url.startsWith('https://');
            const isLocal = url.startsWith('/images/');
            if (!isRemote && !isLocal) {
                Components.showToast('Ошибка', 'Введите ссылку http(s) или путь /images/...', 'error');
                return;
            }

            productImages.push(url);
            input.value = '';
            renderImages();
            Components.showToast('Успешно', 'Изображение добавлено', 'success');
        }

        async function uploadImageFile() {
            const input = document.getElementById('new-image-file');
            const file = input.files && input.files[0];

            if (!file) {
                Components.showToast('Ошибка', 'Выберите файл изображения', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/uploads/products', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const payload = await response.json().catch(() => ({}));

                if (!response.ok || !payload.url) {
                    Components.showToast('Ошибка', payload.message || 'Не удалось загрузить файл', 'error');
                    return;
                }

                productImages.push(payload.url);
                if (payload.url.startsWith('/images/products/')) {
                    sessionUploadedImages.add(payload.url);
                }
                input.value = '';
                renderImages();
                Components.showToast('Успешно', 'Файл загружен', 'success');
            } catch (error) {
                console.error('Upload failed:', error);
                Components.showToast('Ошибка', 'Не удалось загрузить файл', 'error');
            }
        }

        function removeImage(index) {
            Components.confirm('Удалить изображение?', 'Это действие нельзя отменить', () => {
                const url = productImages[index];
                productImages.splice(index, 1);
                renderImages();
                Components.showToast('Успешно', 'Изображение удалено', 'success');

                if (url && sessionUploadedImages.has(url)) {
                    deleteProductImage(url);
                    sessionUploadedImages.delete(url);
                }
            });
        }

        async function deleteProductImage(url) {
            if (!url || !url.startsWith('/images/products/')) return;
            try {
                await fetch('/api/uploads/products/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
            } catch (error) {
                console.warn('Failed to delete product image:', error);
            }
        }

        async function cleanupSessionUploads() {
            const uploads = Array.from(sessionUploadedImages);
            if (uploads.length === 0) return;
            await Promise.all(uploads.map((url) => deleteProductImage(url)));
            sessionUploadedImages.clear();
        }

        async function handleBackNavigation() {
            await cleanupSessionUploads();
            window.history.back();
        }

        // Drag and Drop handlers
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            e.preventDefault();
            const dropIndex = parseInt(e.currentTarget.dataset.index);

            if (draggedIndex !== dropIndex) {
                const draggedItem = productImages[draggedIndex];
                productImages.splice(draggedIndex, 1);
                productImages.splice(dropIndex, 0, draggedItem);
                renderImages();
            }

            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            draggedIndex = null;
        }

        const defaultPalette = [
            { name: 'Black', hex: '#2D2D2D' },
            { name: 'White', hex: '#FFFFFF' },
            { name: 'Beige', hex: '#D4C4B0' },
            { name: 'Navy', hex: '#1A2B4A' },
            { name: 'Grey', hex: '#8B8B8B' },
            { name: 'Brown', hex: '#6B4423' }
        ];

        const defaultSizes = ['XS', 'S', 'M', 'L', 'XL'];

        function normalizePalette(value) {
            if (!value) return [...defaultPalette];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultPalette];
                const cleaned = parsed
                    .filter(item => item && item.name)
                    .map(item => ({
                        name: String(item.name).trim(),
                        hex: String(item.hex || '').trim() || '#CCCCCC'
                    }))
                    .filter(item => item.name.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultPalette];
            } catch (error) {
                return [...defaultPalette];
            }
        }

        function normalizeSizesList(value) {
            if (!value) return [...defaultSizes];
            try {
                const parsed = typeof value === 'string' ? JSON.parse(value) : value;
                if (!Array.isArray(parsed)) return [...defaultSizes];
                const cleaned = parsed
                    .map(item => String(item).trim())
                    .filter(item => item.length > 0);
                return cleaned.length > 0 ? cleaned : [...defaultSizes];
            } catch (error) {
                return [...defaultSizes];
            }
        }

        async function loadVariantOptions() {
            try {
                const settings = await API.settings.get();
                paletteColors = normalizePalette(settings.color_palette);
                settingsSizes = normalizeSizesList(settings.sizes_list || settings.sizesList);
            } catch (error) {
                paletteColors = [...defaultPalette];
                settingsSizes = [...defaultSizes];
            }
        }

        function getVariantsFromMatrix() {
            return Array.from(document.querySelectorAll('.variants-input')).map(input => ({
                color: input.dataset.color,
                size: input.dataset.size,
                stock: parseInt(input.value, 10) || 0
            }));
        }

        function renderVariantsMatrix(colors, sizes, variants = []) {
            const container = document.getElementById('variants-matrix');

            if (!colors.length || !sizes.length) {
                container.innerHTML = '<div class="form-hint">Добавьте цвета и размеры, чтобы задать остатки.</div>';
                return;
            }

            const variantMap = new Map();
            variants.forEach(v => {
                const key = `${v.color}||${v.size}`;
                variantMap.set(key, Math.max(0, parseInt(v.stock, 10) || 0));
            });

            let html = '<div class="variants-table">';
            html += '<div class="variants-row">';
            html += '<div class="variants-cell variants-cell-head"></div>';
            html += sizes.map(size => `<div class="variants-cell variants-cell-head">${size}</div>`).join('');
            html += '</div>';

            colors.forEach(color => {
                html += '<div class="variants-row">';
                html += `<div class="variants-cell variants-cell-head">${color}</div>`;
                sizes.forEach(size => {
                    const key = `${color}||${size}`;
                    const stock = variantMap.has(key) ? variantMap.get(key) : 0;
                    html += `
                        <div class="variants-cell">
                            <input type="number" class="variants-input" data-color="${color}" data-size="${size}" min="0" value="${stock}">
                        </div>
                    `;
                });
                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function initializeVariantsMatrix(variants = []) {
            const colors = paletteColors.map(color => color.name);
            const sizes = [...settingsSizes];
            renderVariantsMatrix(colors, sizes, variants);
        }

        // Allow Enter key to add image
        document.addEventListener('DOMContentLoaded', () => {
            const imageInput = document.getElementById('new-image-url');
            if (imageInput) {
                imageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addImage();
                    }
                });
            }
        });

        async function loadProduct() {
            const params = new URLSearchParams(window.location.search);
            editingId = params.get('id');

            if (!editingId) {
                renderImages();
                return;
            }

            try {
                const product = await API.products.getById(editingId);
                if (!product) {
                    Components.showToast('Ошибка', 'Товар не найден', 'error');
                    return;
                }
                fillForm(product);
            } catch (error) {
                console.error('Failed to load product:', error);
                Components.showToast('Ошибка', 'Не удалось загрузить товар', 'error');
            }
        }

        function fillForm(product) {

            document.getElementById('page-title').textContent = 'Редактирование: ' + product.title;

            const form = document.getElementById('product-form');
            const images = Array.isArray(product.images) ? product.images : (product.images ? JSON.parse(product.images) : []);
            const colors = Array.isArray(product.colors) ? product.colors : (product.colors ? JSON.parse(product.colors) : []);
            const sizes = Array.isArray(product.sizes) ? product.sizes : (product.sizes ? JSON.parse(product.sizes) : []);
            const settingsColors = paletteColors.map(color => color.name);
            const mergedColors = Array.from(new Set([...settingsColors, ...colors]));
            const mergedSizes = Array.from(new Set([...settingsSizes, ...sizes]));

            // Load images
            productImages = images.length > 0 ? images : [];
            renderImages();

            sessionUploadedImages.clear();

            form.querySelector('[name="title"]').value = product.title;
            form.querySelector('[name="category"]').value = product.category;
            form.querySelector('[name="status"]').value = product.status;
            form.querySelector('[name="price"]').value = product.price;
            form.querySelector('[name="oldPrice"]').value = product.oldPrice || product.old_price || '';
            form.querySelector('[name="cost"]').value = product.cost || '';
            form.querySelector('[name="stock"]').value = product.stock;
            form.querySelector('[name="lowStockThreshold"]').value = product.lowStockThreshold || product.low_stock_threshold || 10;
            form.querySelector('[name="shortDescription"]').value = product.shortDescription || product.short_description || product.description || '';
            form.querySelector('[name="fullDescription"]').value = product.fullDescription || product.full_description || product.description || '';
            form.querySelector('[name="material"]').value = product.material || '';
            form.querySelector('[name="care"]').value = product.care || '';

            renderVariantsMatrix(mergedColors, mergedSizes, product.variants || []);

            // Tags
            if (product.tags) {
                product.tags.forEach(tag => {
                    const checkbox = form.querySelector(`[name="tags"][value="${tag}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        function getFormData() {
            const form = document.getElementById('product-form');
            const data = {
                title: form.querySelector('[name="title"]').value,
                category: form.querySelector('[name="category"]').value,
                status: form.querySelector('[name="status"]').value,
                price: parseInt(form.querySelector('[name="price"]').value) || 0,
                oldPrice: parseInt(form.querySelector('[name="oldPrice"]').value) || null,
                cost: parseInt(form.querySelector('[name="cost"]').value) || null,
                stock: parseInt(form.querySelector('[name="stock"]').value) || 0,
                lowStockThreshold: parseInt(form.querySelector('[name="lowStockThreshold"]').value) || 5,
                shortDescription: form.querySelector('[name="shortDescription"]').value,
                fullDescription: form.querySelector('[name="fullDescription"]').value,
                description: form.querySelector('[name="fullDescription"]').value || form.querySelector('[name="shortDescription"]').value,
                material: form.querySelector('[name="material"]').value,
                care: form.querySelector('[name="care"]').value,
                fit: 'Regular fit',
                rating: 0,
                reviewsCount: 0
            };

            // Tags
            const tagCheckboxes = form.querySelectorAll('[name="tags"]:checked');
            data.tags = Array.from(tagCheckboxes).map(cb => cb.value);

            // Colors and sizes from settings
            data.colors = paletteColors.map(color => color.name);
            data.sizes = [...settingsSizes];

            // Variants
            const variants = getVariantsFromMatrix();
            if (variants.length > 0) {
                data.variants = variants;
                data.stock = variants.reduce((sum, v) => sum + v.stock, 0);
            }

            // Images from gallery
            data.images = productImages.length > 0 ? productImages : ['https://via.placeholder.com/400'];

            return data;
        }

        function validateForm() {
            const data = getFormData();

            if (!data.title) {
                Components.showToast('Ошибка', 'Укажите название товара', 'error');
                return false;
            }

            if (data.price <= 0) {
                Components.showToast('Ошибка', 'Укажите цену', 'error');
                return false;
            }

            return true;
        }

        async function saveProduct() {
            if (!validateForm()) return;

            const data = getFormData();
            data.status = 'active';

            try {
                if (editingId) {
                    await API.products.update(editingId, data);
                    Components.showToast('Успешно', 'Товар обновлен', 'success');
                } else {
                    await API.products.create(data);
                    Components.showToast('Успешно', 'Товар создан', 'success');
                }

                setTimeout(() => {
                    window.location.href = '/admin/products';
                }, 500);
            } catch (error) {
                console.error('Failed to save product:', error);
                Components.showToast('Ошибка', 'Не удалось сохранить товар', 'error');
            }
        }

        async function saveDraft() {
            if (!validateForm()) return;

            const data = getFormData();
            data.status = 'draft';

            try {
                if (editingId) {
                    await API.products.update(editingId, data);
                } else {
                    await API.products.create(data);
                }

                Components.showToast('Успешно', 'Черновик сохранен', 'success');
            } catch (error) {
                console.error('Failed to save draft:', error);
                Components.showToast('Ошибка', 'Не удалось сохранить черновик', 'error');
            }
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;

                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCategories();
            await loadVariantOptions();
            await loadProduct();
            if (!editingId) {
                initializeVariantsMatrix();
            }
        });
    </script>
</body>

</html>