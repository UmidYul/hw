<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ó–∞–∫–∞–∑ ‚Äî AURA Admin</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                    <div class="topbar-search">
                        <input type="text" class="topbar-search-input" placeholder="–ü–æ–∏—Å–∫... (–Ω–∞–∂–º–∏—Ç–µ /)"
                            id="global-search">
                        <span class="topbar-search-icon">üîç</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="page-header">
                    <div>
                        <button class="btn btn-secondary btn-sm" onclick="history.back()" style="margin-bottom: 8px;">‚Üê
                            –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º</button>
                        <h1 class="page-title" id="orderTitle">–ó–∞–∫–∞–∑ #...</h1>
                        <p class="page-subtitle" id="orderDate">...</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                        <select class="btn btn-primary" id="statusSelect" onchange="changeStatus()">
                            <option value="">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</option>
                            <option value="new">–ù–æ–≤—ã–π</option>
                            <option value="paid">–û–ø–ª–∞—á–µ–Ω</option>
                            <option value="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
                            <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-3">
                    <!-- Order Info -->
                    <div class="card col-span-2">
                        <div class="card-header">
                            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
                        </div>
                        <div class="card-body">
                            <div class="order-info-grid">
                                <div>
                                    <div class="label">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</div>
                                    <div class="value" id="orderNumber">...</div>
                                </div>
                                <div>
                                    <div class="label">–°—Ç–∞—Ç—É—Å</div>
                                    <div class="value" id="orderStatus">...</div>
                                </div>
                                <div>
                                    <div class="label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</div>
                                    <div class="value" id="orderCreated">...</div>
                                </div>
                                <div>
                                    <div class="label">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
                                    <div class="value" id="orderPayment">–û–Ω–ª–∞–π–Ω</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="card">
                        <div class="card-header">
                            <h3>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</h3>
                        </div>
                        <div class="card-body">
                            <div class="customer-info" id="customerInfo">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="card">
                    <div class="card-header">
                        <h3>–¢–æ–≤–∞—Ä—ã</h3>
                    </div>
                    <div class="card-body">
                        <div class="order-items" id="orderItems">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>

                <div class="grid grid-3">
                    <!-- Shipping Address -->
                    <div class="card col-span-2">
                        <div class="card-header">
                            <h3>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</h3>
                        </div>
                        <div class="card-body">
                            <div id="shippingAddress">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>

                    <!-- Order Total -->
                    <div class="card">
                        <div class="card-header">
                            <h3>–ò—Ç–æ–≥–æ</h3>
                        </div>
                        <div class="card-body">
                            <div class="order-totals" id="orderTotals">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <!-- Status Timeline -->
                    <div class="card">
                        <div class="card-header">
                            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤</h3>
                        </div>
                        <div class="card-body">
                            <div class="timeline" id="statusTimeline">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>

                    <!-- Manager Notes -->
                    <div class="card">
                        <div class="card-header">
                            <h3>–ó–∞–º–µ—Ç–∫–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
                        </div>
                        <div class="card-body">
                            <textarea id="managerNotes" rows="8" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –æ –∑–∞–∫–∞–∑–µ..."
                                style="width: 100%; padding: 12px; border: 1px solid #E5E5E5; border-radius: 2px; font-family: inherit; resize: vertical;"></textarea>
                            <button class="btn btn-primary" onclick="saveNotes()" style="margin-top: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                –∑–∞–º–µ—Ç–∫—É</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>

    <script>
        let currentOrder = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadOrder();
            setupSidebar();
            setupSearch();
        });

        // Get order ID from URL
        function getOrderId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Load order
        async function loadOrder() {
            const orderId = getOrderId();
            if (!orderId) {
                window.location.href = 'orders.html';
                return;
            }

            try {
                console.log('Loading order:', orderId);
                currentOrder = await API.orders.getById(orderId);
                console.log('Order loaded:', currentOrder);

                if (!currentOrder) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }

                try {
                    renderOrder();
                } catch (renderError) {
                    console.error('Render error:', renderError);
                    Components.showToast('–û—à–∏–±–∫–∞', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + renderError.message, 'error');
                }
            } catch (error) {
                console.error('Failed to load order:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑: ' + error.message, 'error');
            }
        }

        // Render order
        function renderOrder() {
            const order = currentOrder;

            // Header
            document.getElementById('orderTitle').textContent = `–ó–∞–∫–∞–∑ ${order.order_number || order.id}`;
            document.getElementById('orderDate').textContent = Components.formatDate(order.created_at);

            // Order info
            document.getElementById('orderNumber').textContent = order.order_number || order.id;
            document.getElementById('orderStatus').innerHTML = getStatusBadge(order.status);
            document.getElementById('orderCreated').textContent = Components.formatDate(order.created_at);
            document.getElementById('orderPayment').textContent = order.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω';

            // Customer
            document.getElementById('customerInfo').innerHTML = `
                <div class="customer-avatar">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(order.customer_name || 'User')}&background=C9A26C&color=fff" alt="${order.customer_name}">
                </div>
                <div style="margin-top: 12px;">
                    <div style="font-weight: 500; margin-bottom: 4px;">${order.customer_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                    <div style="color: #666; font-size: 14px;">
                        ${order.customer_email || ''}<br>
                        ${order.customer_phone || ''}
                    </div>
                </div>
            `;

            // Items
            const itemsHtml = order.items.map(item => {
                return `
                    <div class="order-item">
                        <div class="order-item-info">
                            <div class="order-item-title">${item.title}</div>
                            <div class="order-item-meta">
                                ${item.size ? `–†–∞–∑–º–µ—Ä: ${item.size}` : ''} 
                                ${item.color ? `–¶–≤–µ—Ç: ${item.color}` : ''}
                            </div>
                        </div>
                        <div class="order-item-qty">${item.quantity} —à—Ç.</div>
                        <div class="order-item-price">${Components.formatPrice(item.price)}</div>
                        <div class="order-item-total">${Components.formatPrice(item.price * item.quantity)}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('orderItems').innerHTML = itemsHtml;

            // Shipping address
            if (order.shipping_address) {
                try {
                    const addr = typeof order.shipping_address === 'string'
                        ? JSON.parse(order.shipping_address)
                        : order.shipping_address;
                    document.getElementById('shippingAddress').innerHTML = `
                        <p style="line-height: 1.6; margin: 0;">
                            ${addr.name || order.customer_name || ''}<br>
                            ${addr.address || addr}<br>
                            ${addr.city ? `${addr.city}, ${addr.postalCode || ''}<br>` : ''}
                            ${addr.country || '–†–æ—Å—Å–∏—è'}<br>
                            –¢–µ–ª–µ—Ñ–æ–Ω: ${addr.phone || order.customer_phone}
                        </p>
                    `;
                } catch (e) {
                    document.getElementById('shippingAddress').innerHTML = `<p style="line-height: 1.6; margin: 0;">${order.shipping_address}</p>`;
                }
            } else {
                document.getElementById('shippingAddress').innerHTML = '<p class="text-muted">–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω</p>';
            }

            // Totals
            const subtotal = order.subtotal || order.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shipping = order.shipping || 0;
            const discount = order.discount || 0;
            const total = order.total;

            document.getElementById('orderTotals').innerHTML = `
                <div class="total-row">
                    <span>–¢–æ–≤–∞—Ä—ã:</span>
                    <span>${Components.formatPrice(subtotal)}</span>
                </div>
                <div class="total-row">
                    <span>–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                    <span>${shipping === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : Components.formatPrice(shipping)}</span>
                </div>
                ${discount > 0 ? `
                <div class="total-row">
                    <span>–°–∫–∏–¥–∫–∞:</span>
                    <span class="text-success">-${Components.formatPrice(discount)}</span>
                </div>
                ` : ''}
                <div class="total-row total-final">
                    <span><strong>–ò—Ç–æ–≥–æ:</strong></span>
                    <span><strong>${Components.formatPrice(total)}</strong></span>
                </div>
            `;

            // Timeline - show simple status if no history
            document.getElementById('statusTimeline').innerHTML = `
                <div class="timeline-item active">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-status">${getStatusLabel(order.status)}</div>
                        <div class="timeline-date">${Components.formatDate(order.created_at)}</div>
                    </div>
                </div>
            `;

            // Notes
            document.getElementById('managerNotes').value = order.notes || '';
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                new: '<span class="badge badge-info">–ù–æ–≤—ã–π</span>',
                paid: '<span class="badge badge-success">–û–ø–ª–∞—á–µ–Ω</span>',
                shipped: '<span class="badge badge-warning">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>',
                completed: '<span class="badge badge-success">–í—ã–ø–æ–ª–Ω–µ–Ω</span>',
                cancelled: '<span class="badge badge-error">–û—Ç–º–µ–Ω–µ–Ω</span>'
            };
            return badges[status] || `<span class="badge">${status}</span>`;
        }

        // Get status label
        function getStatusLabel(status) {
            const labels = {
                new: '–ù–æ–≤—ã–π –∑–∞–∫–∞–∑',
                paid: '–û–ø–ª–∞—á–µ–Ω',
                shipped: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω',
                completed: '–í—ã–ø–æ–ª–Ω–µ–Ω',
                cancelled: '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return labels[status] || status;
        }

        // Change status
        async function changeStatus() {
            const select = document.getElementById('statusSelect');
            const newStatus = select.value;

            if (!newStatus) return;

            try {
                await API.orders.updateStatus(currentOrder.id, newStatus);
                Components.showToast('–£—Å–ø–µ—Ö', '–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                select.value = '';

                // Reload
                currentOrder = await API.orders.getById(currentOrder.id);
                renderOrder();
            } catch (error) {
                console.error('Failed to update status:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å', 'error');
            }
        }

        // Save notes
        async function saveNotes() {
            const notes = document.getElementById('managerNotes').value;
            try {
                // For now, just show success - notes update can be added to API later
                Components.showToast('–£—Å–ø–µ—Ö', '–ó–∞–º–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
            } catch (error) {
                console.error('Failed to save notes:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É', 'error');
            }
        }

        // Sidebar & Search
        function setupSidebar() {
            document.getElementById('sidebar-toggle')?.addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('sidebar-collapsed');
            });
        }

        function setupSearch() {
            const input = document.getElementById('global-search');
            input?.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') input.blur();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && document.activeElement !== input) {
                    e.preventDefault();
                    input?.focus();
                }
            });
        }
    </script>

    <style>
        .order-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .value {
            font-size: 16px;
            color: #2D2D2D;
        }

        .customer-avatar {
            text-align: center;
        }

        .customer-avatar img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .order-item {
            display: grid;
            grid-template-columns: 1fr 80px 120px 120px;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: #FAFAFA;
            border-radius: 2px;
        }

        .order-item-title {
            font-weight: 500;
        }

        .order-item-meta {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .order-item-qty,
        .order-item-price {
            text-align: center;
        }

        .order-item-total {
            text-align: right;
            font-weight: 500;
        }

        .order-totals {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .total-final {
            border-top: 2px solid #2D2D2D;
            padding-top: 12px;
            margin-top: 4px;
            font-size: 18px;
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .timeline-item {
            display: flex;
            gap: 16px;
            position: relative;
            padding-left: 8px;
        }

        .timeline-item:not(:last-child)::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 24px;
            bottom: -20px;
            width: 2px;
            background: #E5E5E5;
        }

        .timeline-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #E5E5E5;
            background: white;
            flex-shrink: 0;
            margin-top: 4px;
        }

        .timeline-item.active .timeline-dot {
            border-color: #C9A26C;
            background: #C9A26C;
        }

        .timeline-status {
            font-weight: 500;
            color: #2D2D2D;
        }

        .timeline-date {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        @media print {

            .sidebar,
            .topbar,
            .page-header button,
            .card-header h3:first-child::after {
                display: none !important;
            }

            .main-content {
                margin-left: 0;
            }

            .page-content {
                padding: 20px;
            }
        }
    </style>
</body>

</html>