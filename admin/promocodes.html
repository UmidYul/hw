<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–º–æ–∫–æ–¥—ã - AURA Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h1>
                        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="openPromoModal()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</button>
                    </div>
                </div>

                <div class="card">
                    <div id="promos-container">
                        <div class="card-body">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Promo Modal -->
    <div class="modal" id="promo-modal">
        <div class="modal-backdrop" onclick="closePromoModal()"></div>
        <div class="modal-dialog modal-dialog-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">–ù–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥</h3>
                <button class="modal-close" onclick="closePromoModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="promo-form">
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label class="form-label form-label-required">–ö–æ–¥</label>
                            <div class="flex gap-md">
                                <input type="text" class="form-input" name="code" style="flex:1" required>
                                <button type="button" class="btn btn-secondary" onclick="generateCode()">üé≤
                                    –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-select" name="status">
                                <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                                <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3">
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø —Å–∫–∏–¥–∫–∏</label>
                            <select class="form-select" name="type">
                                <option value="percent">–ü—Ä–æ—Ü–µ–Ω—Ç</option>
                                <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label form-label-required">–ó–Ω–∞—á–µ–Ω–∏–µ</label>
                            <input type="number" class="form-input" name="value" required min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ú–∏–Ω. —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞</label>
                            <input type="number" class="form-input" name="minAmount" value="0" min="0">
                        </div>
                    </div>

                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                            <input type="number" class="form-input" name="maxUses" min="0" placeholder="–ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ">
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞</label>
                            <input type="number" class="form-input" name="perUserLimit" min="1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" name="excludeSale">
                            <span>–ù–µ –ø—Ä–∏–º–µ–Ω—è—Ç—å –∫ —Ç–æ–≤–∞—Ä–∞–º —Å–æ —Å–∫–∏–¥–∫–æ–π</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromoModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="savePromo()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/repo.js"></script>
    <script src="/admin/seed.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        let editingId = null;

        async function loadPromos() {
            try {
                const promos = await API.promocodes.getAll();
                const container = document.getElementById('promos-container');

                if (promos.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üé´</div><div class="empty-state-title">–ü—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ—Ç</div></div>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>–ö–æ–¥</th>';
                html += '<th>–¢–∏–ø</th>';
                html += '<th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>';
                html += '<th>–ú–∏–Ω. —Å—É–º–º–∞</th>';
                html += '<th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</th>';
                html += '<th>–°—Ç–∞—Ç—É—Å</th>';
                html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
                html += '</tr></thead><tbody>';

                promos.forEach(promo => {
                    const typeText = promo.type === 'percent' ? `${promo.value}%` : Components.formatPrice(promo.value);
                    const usedCount = promo.usage_count || 0;
                    const usageLimit = promo.usage_limit;

                    let usedText = '';
                    if (usageLimit) {
                        const percentage = Math.round((usedCount / usageLimit) * 100);
                        usedText = `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 2px;">${usedCount} / ${usageLimit}</div>
                                    <div style="width: 100%; height: 6px; background: #E5E5E5; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: ${percentage >= 90 ? '#e74c3c' : percentage >= 70 ? '#f39c12' : '#4CAF50'}; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <span style="font-size: 12px; font-weight: 600; color: #666;">${percentage}%</span>
                            </div>
                        `;
                    } else {
                        usedText = `<div style="text-align: center;">${usedCount}</div>`;
                    }

                    html += `<tr>
                    <td><strong><code>${promo.code}</code></strong></td>
                    <td>${promo.type === 'percent' ? '–ü—Ä–æ—Ü–µ–Ω—Ç' : '–§–∏–∫—Å. —Å—É–º–º–∞'}</td>
                    <td><strong>${typeText}</strong></td>
                    <td>${promo.min_amount ? Components.formatPrice(promo.min_amount) : '‚Äî'}</td>
                    <td style="min-width: 180px;">${usedText}</td>
                    <td>${promo.is_active ? Components.renderBadge('–ê–∫—Ç–∏–≤–µ–Ω', 'success') : Components.renderBadge('–ù–µ–∞–∫—Ç–∏–≤–µ–Ω', 'default')}</td>
                    <td>
                        <button class="btn btn-sm btn-ghost" onclick="editPromo('${promo.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-ghost" onclick="viewStats('${promo.id}')">üìä</button>
                        <button class="btn btn-sm btn-ghost" onclick="deletePromo('${promo.id}')">üóëÔ∏è</button>
                    </td>
                </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load promocodes:', error);
                document.getElementById('promos-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã</div></div>';
            }
        }

        async function openPromoModal(id = null) {
            editingId = id;
            const form = document.getElementById('promo-form');
            form.reset();

            if (id) {
                try {
                    const promo = await API.promocodes.getById(id);
                    if (promo) {
                        document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
                        form.querySelector('[name="code"]').value = promo.code;
                        form.querySelector('[name="type"]').value = promo.type;
                        form.querySelector('[name="value"]').value = promo.value;
                        form.querySelector('[name="minAmount"]').value = promo.min_amount || promo.minAmount || 0;
                        form.querySelector('[name="maxUses"]').value = promo.max_uses || promo.maxUses || '';
                        form.querySelector('[name="perUserLimit"]').value = promo.per_user_limit || promo.perUserLimit || 1;
                        form.querySelector('[name="excludeSale"]').checked = promo.exclude_sale !== undefined ? promo.exclude_sale : promo.excludeSale;
                        form.querySelector('[name="status"]').value = promo.is_active !== undefined ? (promo.is_active ? 'active' : 'inactive') : promo.status;
                    }
                } catch (error) {
                    console.error('Failed to load promocode:', error);
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = '–ù–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
            }

            document.getElementById('promo-modal').classList.add('show');
        }

        function closePromoModal() {
            document.getElementById('promo-modal').classList.remove('show');
            editingId = null;
        }

        function generateCode() {
            // Generate random promo code
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('promo-form').querySelector('[name="code"]').value = code;
        }

        async function savePromo() {
            const form = document.getElementById('promo-form');
            const code = form.querySelector('[name="code"]').value.trim().toUpperCase();

            if (!code) {
                Components.showToast('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
                return;
            }

            const value = parseFloat(form.querySelector('[name="value"]').value);
            if (!value || value <= 0) {
                Components.showToast('–û—à–∏–±–∫–∞', '–£–∫–∞–∂–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏', 'error');
                return;
            }

            const data = {
                code,
                type: form.querySelector('[name="type"]').value,
                value,
                minAmount: parseInt(form.querySelector('[name="minAmount"]').value) || 0,
                usageLimit: parseInt(form.querySelector('[name="maxUses"]').value) || null,
                maxUsesPerUser: parseInt(form.querySelector('[name="perUserLimit"]').value) || 1,
                excludeSale: form.querySelector('[name="excludeSale"]').checked,
                isActive: form.querySelector('[name="status"]').value === 'active',
                startDate: new Date().toISOString(),
                endDate: null
            };

            try {
                if (editingId) {
                    await API.promocodes.update(editingId, data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                } else {
                    await API.promocodes.create(data);
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', 'success');
                }

                closePromoModal();
                await loadPromos();
            } catch (error) {
                console.error('Failed to save promocode:', error);
                if (error.message && error.message.includes('UNIQUE')) {
                    Components.showToast('–û—à–∏–±–∫–∞', '–ü—Ä–æ–º–æ–∫–æ–¥ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                } else {
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                }
            }
        }

        function editPromo(id) {
            openPromoModal(id);
        }

        async function duplicatePromo(id) {
            try {
                const promo = await API.promocodes.getById(id);
                const newCode = promo.code + '-COPY';
                const data = {
                    code: newCode,
                    type: promo.type,
                    value: promo.value,
                    min_amount: promo.min_amount || promo.minAmount || 0,
                    max_uses: promo.max_uses || promo.maxUses,
                    per_user_limit: promo.per_user_limit || promo.perUserLimit || 1,
                    exclude_sale: promo.exclude_sale !== undefined ? promo.exclude_sale : promo.excludeSale,
                    is_active: promo.is_active !== undefined ? promo.is_active : (promo.status === 'active'),
                    start_date: new Date().toISOString(),
                    end_date: null
                };
                await API.promocodes.create(data);
                await loadPromos();
                Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ü—Ä–æ–º–æ–∫–æ–¥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω', 'success');
            } catch (error) {
                console.error('Failed to duplicate promocode:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
            }
        }

        async function deletePromo(id) {
            Components.confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?', '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å', async () => {
                try {
                    await API.promocodes.delete(id);
                    await loadPromos();
                    Components.showToast('–£—Å–ø–µ—à–Ω–æ', '–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
                } catch (error) {
                    console.error('Failed to delete promocode:', error);
                    Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                }
            });
        }

        async function viewStats(id) {
            try {
                const stats = await API.promocodes.getStats(id);

                let historyHtml = '<div style="margin-top: 20px;"><h4>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</h4>';
                if (stats.recentUsage && stats.recentUsage.length > 0) {
                    historyHtml += '<div style="max-height: 300px; overflow-y: auto;"><table class="table"><thead><tr><th>–î–∞—Ç–∞</th><th>–ó–∞–∫–∞–∑</th><th>–ö–ª–∏–µ–Ω—Ç</th></tr></thead><tbody>';
                    stats.recentUsage.forEach(usage => {
                        const date = new Date(usage.used_at).toLocaleString('ru-RU');
                        historyHtml += `<tr>
                            <td>${date}</td>
                            <td>${usage.order_number || '‚Äî'}</td>
                            <td>${usage.customer_name || usage.customer_phone || '‚Äî'}</td>
                        </tr>`;
                    });
                    historyHtml += '</tbody></table></div>';
                } else {
                    historyHtml += '<p style="color: #757575; margin-top: 12px;">–ü—Ä–æ–º–æ–∫–æ–¥ –µ—â–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è</p>';
                }
                historyHtml += '</div>';

                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                    <div class="modal-dialog" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞: ${stats.code}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">‚úï</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid grid-cols-3" style="gap: 16px; margin-bottom: 24px;">
                                <div class="stat-card">
                                    <div class="stat-card-label">–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</div>
                                    <div class="stat-card-value" style="font-size: 32px;">${stats.totalUses}</div>
                                    ${stats.usageLimit ? `<div style="font-size: 12px; color: #757575;">–õ–∏–º–∏—Ç: ${stats.usageLimit}</div>` : ''}
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                                    <div class="stat-card-value" style="font-size: 32px;">${stats.uniqueUsers}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</div>
                                    <div class="stat-card-value" style="font-size: 14px;">${stats.lastUsed ? new Date(stats.lastUsed).toLocaleDateString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞'}</div>
                                </div>
                            </div>
                            ${historyHtml}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Failed to load stats:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadPromos, 300);
        });
    </script>
</body>

</html>