<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Промокоды - Higher Waist Admin</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">Higher Waist Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Основное</div>
                    <a href="/admin" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Каталог</div>
                    <a href="/admin/products" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Товары</span>
                    </a>
                    <a href="/admin/categories" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Категории</span>
                    </a>
                    <a href="/admin/collections" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Коллекции</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Маркетинг</div>
                    <a href="/admin/discounts" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Скидки</span>
                    </a>
                    <a href="/admin/promocodes" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon"></span>
                        <span>Промокоды</span>
                    </a>
                    <a href="/admin/banners" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Баннеры</span>
                    </a>
                    <a href="/admin/newsletters" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Рассылки</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Продажи</div>
                    <a href="/admin/orders" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Заказы</span>
                    </a>
                    <a href="/admin/customers" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Клиенты</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Контент</div>
                    <a href="/admin/pages" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Страницы</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">Настройки</div>
                    <a href="/admin/settings" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon"></span>
                        <span>Настройки</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">Меню</button>
                </div>
                <div class="topbar-right">
                    <div class="topbar-profile">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">Администратор</div>
                    </div>
                </div>
            </header>

            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Промокоды</h1>
                        <p class="page-subtitle">Управление промокодами</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-primary" onclick="openPromoModal()">Создать промокод</button>
                    </div>
                </div>

                <div class="card">
                    <div id="promos-container">
                        <div class="card-body">
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Promo Modal -->
    <div class="modal" id="promo-modal">
        <div class="modal-backdrop" onclick="closePromoModal()"></div>
        <div class="modal-dialog modal-dialog-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Новый промокод</h3>
                <button class="modal-close" onclick="closePromoModal()">Закрыть</button>
            </div>
            <div class="modal-body">
                <form id="promo-form">
                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label class="form-label form-label-required">Код</label>
                            <div class="flex gap-md">
                                <input type="text" class="form-input" name="code" style="flex:1" required>
                                <button type="button" class="btn btn-secondary"
                                    onclick="generateCode()">Генерировать</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Статус</label>
                            <select class="form-select" name="status">
                                <option value="active">Активен</option>
                                <option value="inactive">Неактивен</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3">
                        <div class="form-group">
                            <label class="form-label">Тип скидки</label>
                            <select class="form-select" name="type">
                                <option value="percent">Процент</option>
                                <option value="fixed">Фиксированная сумма</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label form-label-required">Значение</label>
                            <input type="number" class="form-input" name="value" required min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Мин. сумма заказа</label>
                            <input type="number" class="form-input" name="minAmount" value="0" min="0">
                        </div>
                    </div>

                    <div class="grid grid-cols-2">
                        <div class="form-group">
                            <label class="form-label">Макс. использований</label>
                            <input type="number" class="form-input" name="maxUses" min="0" placeholder="Не ограничено">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Использований на клиента</label>
                            <input type="number" class="form-input" name="perUserLimit" min="1" value="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-checkbox">
                            <input type="checkbox" name="excludeSale">
                            <span>Не применять к товарам со скидкой</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromoModal()">Отмена</button>
                <button class="btn btn-primary" onclick="savePromo()">Сохранить</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="/js/api.js"></script>
    <script src="/admin/repo.js"></script>
    <script src="/admin/seed.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        let editingId = null;

        async function loadPromos() {
            try {
                const promos = await API.promocodes.getAll();
                const container = document.getElementById('promos-container');

                if (promos.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"></div><div class="empty-state-title">Промокодов нет</div></div>';
                    return;
                }

                let html = '<table class="table"><thead><tr>';
                html += '<th>Код</th>';
                html += '<th>Тип</th>';
                html += '<th>Значение</th>';
                html += '<th>Мин. сумма</th>';
                html += '<th>Использовано</th>';
                html += '<th>Статус</th>';
                html += '<th>Действия</th>';
                html += '</tr></thead><tbody>';

                promos.forEach(promo => {
                    const typeText = promo.type === 'percent' ? `${promo.value}%` : Components.formatPrice(promo.value);
                    const usedCount = promo.usage_count || 0;
                    const usageLimit = promo.usage_limit;

                    let usedText = '';
                    if (usageLimit) {
                        const percentage = Math.round((usedCount / usageLimit) * 100);
                        usedText = `
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 2px;">${usedCount} / ${usageLimit}</div>
                                    <div style="width: 100%; height: 6px; background: #E5E5E5; border-radius: 3px; overflow: hidden;">
                                        <div style="width: ${percentage}%; height: 100%; background: ${percentage >= 90 ? '#e74c3c' : percentage >= 70 ? '#f39c12' : '#4CAF50'}; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <span style="font-size: 12px; font-weight: 600; color: #666;">${percentage}%</span>
                            </div>
                        `;
                    } else {
                        usedText = `<div style="text-align: center;">${usedCount}</div>`;
                    }

                    html += `<tr>
                    <td><strong><code>${promo.code}</code></strong></td>
                    <td>${promo.type === 'percent' ? 'Процент' : 'Фикс. сумма'}</td>
                    <td><strong>${typeText}</strong></td>
                    <td>${promo.min_amount ? Components.formatPrice(promo.min_amount) : '—'}</td>
                    <td style="min-width: 180px;">${usedText}</td>
                    <td>${promo.is_active ? Components.renderBadge('Активен', 'success') : Components.renderBadge('Неактивен', 'default')}</td>
                    <td>
                        <button class="btn btn-sm btn-ghost" onclick="editPromo('${promo.id}')">Редактировать</button>
                        <button class="btn btn-sm btn-ghost" onclick="viewStats('${promo.id}')">Статистика</button>
                        <button class="btn btn-sm btn-ghost" onclick="deletePromo('${promo.id}')">Удалить</button>
                    </td>
                </tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Failed to load promocodes:', error);
                document.getElementById('promos-container').innerHTML = '<div class="empty-state"><div class="empty-state-icon">Ошибка</div><div class="empty-state-title">Не удалось загрузить промокоды</div></div>';
            }
        }

        async function openPromoModal(id = null) {
            editingId = id;
            const form = document.getElementById('promo-form');
            form.reset();

            if (id) {
                try {
                    const promo = await API.promocodes.getById(id);
                    if (promo) {
                        document.getElementById('modal-title').textContent = 'Редактировать промокод';
                        form.querySelector('[name="code"]').value = promo.code;
                        form.querySelector('[name="type"]').value = promo.type;
                        form.querySelector('[name="value"]').value = promo.value;
                        form.querySelector('[name="minAmount"]').value = promo.min_amount || promo.minAmount || 0;
                        form.querySelector('[name="maxUses"]').value = promo.max_uses || promo.maxUses || '';
                        form.querySelector('[name="perUserLimit"]').value = promo.per_user_limit || promo.perUserLimit || 1;
                        form.querySelector('[name="excludeSale"]').checked = promo.exclude_sale !== undefined ? promo.exclude_sale : promo.excludeSale;
                        form.querySelector('[name="status"]').value = promo.is_active !== undefined ? (promo.is_active ? 'active' : 'inactive') : promo.status;
                    }
                } catch (error) {
                    console.error('Failed to load promocode:', error);
                    Components.showToast('Ошибка', 'Не удалось загрузить промокод', 'error');
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = 'Новый промокод';
            }

            document.getElementById('promo-modal').classList.add('show');
        }

        function closePromoModal() {
            document.getElementById('promo-modal').classList.remove('show');
            editingId = null;
        }

        function generateCode() {
            // Generate random promo code
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('promo-form').querySelector('[name="code"]').value = code;
        }

        async function savePromo() {
            const form = document.getElementById('promo-form');
            const code = form.querySelector('[name="code"]').value.trim().toUpperCase();

            if (!code) {
                Components.showToast('Ошибка', 'Укажите код промокода', 'error');
                return;
            }

            const value = parseFloat(form.querySelector('[name="value"]').value);
            if (!value || value <= 0) {
                Components.showToast('Ошибка', 'Укажите значение скидки', 'error');
                return;
            }

            const data = {
                code,
                type: form.querySelector('[name="type"]').value,
                value,
                minAmount: parseInt(form.querySelector('[name="minAmount"]').value) || 0,
                usageLimit: parseInt(form.querySelector('[name="maxUses"]').value) || null,
                maxUsesPerUser: parseInt(form.querySelector('[name="perUserLimit"]').value) || 1,
                excludeSale: form.querySelector('[name="excludeSale"]').checked,
                isActive: form.querySelector('[name="status"]').value === 'active',
                startDate: new Date().toISOString(),
                endDate: null
            };

            try {
                if (editingId) {
                    await API.promocodes.update(editingId, data);
                    Components.showToast('Успешно', 'Промокод обновлен', 'success');
                } else {
                    await API.promocodes.create(data);
                    Components.showToast('Успешно', 'Промокод создан', 'success');
                }

                closePromoModal();
                await loadPromos();
            } catch (error) {
                console.error('Failed to save promocode:', error);
                if (error.message && error.message.includes('UNIQUE')) {
                    Components.showToast('Ошибка', 'Промокод с таким кодом уже существует', 'error');
                } else {
                    Components.showToast('Ошибка', 'Не удалось сохранить промокод', 'error');
                }
            }
        }

        function editPromo(id) {
            openPromoModal(id);
        }

        async function duplicatePromo(id) {
            try {
                const promo = await API.promocodes.getById(id);
                const newCode = promo.code + '-COPY';
                const data = {
                    code: newCode,
                    type: promo.type,
                    value: promo.value,
                    min_amount: promo.min_amount || promo.minAmount || 0,
                    max_uses: promo.max_uses || promo.maxUses,
                    per_user_limit: promo.per_user_limit || promo.perUserLimit || 1,
                    exclude_sale: promo.exclude_sale !== undefined ? promo.exclude_sale : promo.excludeSale,
                    is_active: promo.is_active !== undefined ? promo.is_active : (promo.status === 'active'),
                    start_date: new Date().toISOString(),
                    end_date: null
                };
                await API.promocodes.create(data);
                await loadPromos();
                Components.showToast('Успешно', 'Промокод дублирован', 'success');
            } catch (error) {
                console.error('Failed to duplicate promocode:', error);
                Components.showToast('Ошибка', 'Не удалось дублировать промокод', 'error');
            }
        }

        async function deletePromo(id) {
            Components.confirm('Удалить промокод?', 'Это действие нельзя отменить', async () => {
                try {
                    await API.promocodes.delete(id);
                    await loadPromos();
                    Components.showToast('Успешно', 'Промокод удален', 'success');
                } catch (error) {
                    console.error('Failed to delete promocode:', error);
                    Components.showToast('Ошибка', 'Не удалось удалить промокод', 'error');
                }
            });
        }

        async function viewStats(id) {
            try {
                const stats = await API.promocodes.getStats(id);

                let historyHtml = '<div style="margin-top: 20px;"><h4>Последние использования:</h4>';
                if (stats.recentUsage && stats.recentUsage.length > 0) {
                    historyHtml += '<div style="max-height: 300px; overflow-y: auto;"><table class="table"><thead><tr><th>Дата</th><th>Заказ</th><th>Клиент</th></tr></thead><tbody>';
                    stats.recentUsage.forEach(usage => {
                        const date = new Date(usage.used_at).toLocaleString('ru-RU');
                        historyHtml += `<tr>
                            <td>${date}</td>
                            <td>${usage.order_number || '—'}</td>
                            <td>${usage.customer_name || usage.customer_phone || '—'}</td>
                        </tr>`;
                    });
                    historyHtml += '</tbody></table></div>';
                } else {
                    historyHtml += '<p style="color: #757575; margin-top: 12px;">Промокод еще не использовался</p>';
                }
                historyHtml += '</div>';

                const modal = document.createElement('div');
                modal.className = 'modal show';
                modal.innerHTML = `
                    <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                    <div class="modal-dialog" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Статистика промокода: ${stats.code}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">Закрыть</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid grid-cols-3" style="gap: 16px; margin-bottom: 24px;">
                                <div class="stat-card">
                                    <div class="stat-card-label">Всего использований</div>
                                    <div class="stat-card-value" style="font-size: 32px;">${stats.totalUses}</div>
                                    ${stats.usageLimit ? `<div style="font-size: 12px; color: #757575;">Лимит: ${stats.usageLimit}</div>` : ''}
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-label">Уникальных клиентов</div>
                                    <div class="stat-card-value" style="font-size: 32px;">${stats.uniqueUsers}</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-card-label">Последнее использование</div>
                                    <div class="stat-card-value" style="font-size: 14px;">${stats.lastUsed ? new Date(stats.lastUsed).toLocaleDateString('ru-RU') : 'Никогда'}</div>
                                </div>
                            </div>
                            ${historyHtml}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Закрыть</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Failed to load stats:', error);
                Components.showToast('Ошибка', 'Не удалось загрузить статистику', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(loadPromos, 300);
        });
    </script>
</body>

</html>