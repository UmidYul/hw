<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - AURA Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/admin/styles.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <div class="sidebar-logo-icon">A</div>
                    <div class="sidebar-logo-text">AURA Admin</div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
                    <a href="index.html" class="sidebar-nav-link active">
                        <span class="sidebar-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ö–∞—Ç–∞–ª–æ–≥</div>
                    <a href="products.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üì¶</span>
                        <span>–¢–æ–≤–∞—Ä—ã</span>
                    </a>
                    <a href="categories.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üè∑Ô∏è</span>
                        <span>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
                    </a>
                    <a href="collections.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üìö</span>
                        <span>–ö–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥</div>
                    <a href="discounts.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üí∞</span>
                        <span>–°–∫–∏–¥–∫–∏</span>
                    </a>
                    <a href="promocodes.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üé´</span>
                        <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                    </a>
                    <a href="banners.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üñºÔ∏è</span>
                        <span>–ë–∞–Ω–Ω–µ—Ä—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ü—Ä–æ–¥–∞–∂–∏</div>
                    <a href="orders.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üõçÔ∏è</span>
                        <span>–ó–∞–∫–∞–∑—ã</span>
                    </a>
                    <a href="customers.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">üë•</span>
                        <span>–ö–ª–∏–µ–Ω—Ç—ã</span>
                    </a>
                </div>

                <div class="sidebar-nav-section">
                    <div class="sidebar-nav-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                    <a href="settings.html" class="sidebar-nav-link">
                        <span class="sidebar-nav-icon">‚öôÔ∏è</span>
                        <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebar-toggle">‚ò∞</button>
                    <div class="topbar-search">
                        <input type="text" class="topbar-search-input" placeholder="–ü–æ–∏—Å–∫... (–Ω–∞–∂–º–∏—Ç–µ /)"
                            id="global-search">
                        <span class="topbar-search-icon">üîç</span>
                    </div>
                </div>

                <div class="topbar-right">
                    <button class="topbar-btn" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è">
                        <span>üîî</span>
                        <span class="topbar-btn-badge"></span>
                    </button>

                    <div class="topbar-profile" id="profile-btn">
                        <div class="topbar-profile-avatar">A</div>
                        <div class="topbar-profile-name">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Dashboard</h1>
                        <p class="page-subtitle">–û–±–∑–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞</p>
                    </div>
                    <div class="page-actions">
                        <button class="btn btn-secondary" onclick="window.location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                        <button class="btn btn-primary" onclick="window.location.href='product-edit.html'">‚ûï –°–æ–∑–¥–∞—Ç—å
                            —Ç–æ–≤–∞—Ä</button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-4">
                    <div class="stat-card">
                        <div class="stat-card-content">
                            <div class="stat-card-label">–í—ã—Ä—É—á–∫–∞</div>
                            <div class="stat-card-value" id="revenue">‚Äî</div>
                            <div class="stat-card-change positive">
                                <span>‚Üë</span>
                                <span>12.5%</span>
                            </div>
                        </div>
                        <div class="stat-card-icon accent">üí∞</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-content">
                            <div class="stat-card-label">–ó–∞–∫–∞–∑—ã</div>
                            <div class="stat-card-value" id="orders-count">‚Äî</div>
                            <div class="stat-card-change positive">
                                <span>‚Üë</span>
                                <span>8.3%</span>
                            </div>
                        </div>
                        <div class="stat-card-icon success">üõçÔ∏è</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-content">
                            <div class="stat-card-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
                            <div class="stat-card-value" id="avg-order">‚Äî</div>
                            <div class="stat-card-change negative">
                                <span>‚Üì</span>
                                <span>2.1%</span>
                            </div>
                        </div>
                        <div class="stat-card-icon info">üìä</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-card-content">
                            <div class="stat-card-label">–¢–æ–≤–∞—Ä—ã</div>
                            <div class="stat-card-value" id="products-count">‚Äî</div>
                            <div class="stat-card-change positive">
                                <span>‚Üë</span>
                                <span>5 –Ω–æ–≤—ã—Ö</span>
                            </div>
                        </div>
                        <div class="stat-card-icon accent">üì¶</div>
                    </div>
                </div>

                <!-- Recent Orders -->
                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–∫–∞–∑—ã</h3>
                    </div>
                    <div class="card-body" id="recent-orders">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>

                <!-- Top Products -->
                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">–¢–æ–ø —Ç–æ–≤–∞—Ä—ã</h3>
                    </div>
                    <div class="card-body" id="top-products">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>

                <!-- Low Stock Products -->
                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">–¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º</h3>
                    </div>
                    <div class="card-body" id="low-stock">
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-3 mt-lg">
                    <button class="btn btn-secondary" onclick="window.location.href='product-edit.html'">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='banners.html'">
                        üñºÔ∏è –°–æ–∑–¥–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='promocodes.html'">
                        üé´ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Scripts -->
    <script src="/js/api.js"></script>
    <script src="/admin/components.js"></script>
    <script>
        // Initialize Dashboard
        async function initDashboard() {
            try {
                // Load stats from API
                const stats = await API.stats.getDashboard(30);

                // Update KPIs
                document.getElementById('revenue').textContent = Components.formatPrice(stats.revenue.total);
                document.getElementById('orders-count').textContent = stats.orders.total;
                document.getElementById('avg-order').textContent = Components.formatPrice(stats.avgOrder);
                document.getElementById('products-count').textContent = stats.products;

                // Update revenue change indicator
                const revenueChange = stats.revenue.change;
                const revenueChangeEl = document.querySelector('#revenue').parentElement.querySelector('.stat-card-change');
                if (revenueChangeEl) {
                    revenueChangeEl.className = `stat-card-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;
                    revenueChangeEl.innerHTML = `
                        <span class="stat-card-arrow">${revenueChange >= 0 ? '‚Üë' : '‚Üì'}</span>
                        <span>${Math.abs(revenueChange).toFixed(1)}% —Å –ø—Ä–æ—à–ª–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞</span>
                    `;
                }

                // Recent Orders
                document.getElementById('recent-orders').innerHTML = Components.renderTable({
                    data: stats.recentOrders.map(o => ({
                        ...o,
                        number: o.order_number,
                        customer: { name: o.customer_name },
                        createdAt: o.created_at
                    })),
                    columns: [
                        { label: '–ù–æ–º–µ—Ä', field: 'number' },
                        { label: '–ö–ª–∏–µ–Ω—Ç', field: 'customer', render: (row) => row.customer.name },
                        { label: '–°—É–º–º–∞', field: 'total', render: (row) => Components.formatPrice(row.total) },
                        {
                            label: '–°—Ç–∞—Ç—É—Å', field: 'status', render: (row) => {
                                const badges = {
                                    new: { text: '–ù–æ–≤—ã–π', type: 'info' },
                                    paid: { text: '–û–ø–ª–∞—á–µ–Ω', type: 'success' },
                                    processing: { text: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ', type: 'warning' },
                                    shipped: { text: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω', type: 'warning' },
                                    delivered: { text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', type: 'success' },
                                    completed: { text: '–ó–∞–≤–µ—Ä—à–µ–Ω', type: 'success' },
                                    cancelled: { text: '–û—Ç–º–µ–Ω–µ–Ω', type: 'error' }
                                };
                                const badge = badges[row.status] || { text: row.status, type: 'default' };
                                return Components.renderBadge(badge.text, badge.type);
                            }
                        },
                        { label: '–î–∞—Ç–∞', field: 'createdAt', render: (row) => Components.formatDate(row.createdAt) }
                    ],
                    actions: [
                        { label: '–û—Ç–∫—Ä—ã—Ç—å', handler: 'viewOrder' }
                    ]
                });

                // Top Products
                if (stats.topProducts && stats.topProducts.length > 0) {
                    const topProductsHtml = stats.topProducts.map(p => `
                        <div style="display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #E5E5E5;">
                            <div>
                                <strong>${p.title}</strong>
                                <div style="color: #757575; font-size: 12px;">${p.sku}</div>
                            </div>
                            <div style="text-align: right;">
                                <div><strong>${Components.formatPrice(p.revenue)}</strong></div>
                                <div style="color: #757575; font-size: 12px;">–ü—Ä–æ–¥–∞–Ω–æ: ${p.total_sold}</div>
                            </div>
                        </div>
                    `).join('');

                    document.getElementById('top-products').innerHTML = topProductsHtml || '<p style="color: #757575;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                } else {
                    document.getElementById('top-products').innerHTML = '<p style="color: #757575;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
                }

                // Load products for low stock check
                const products = await API.products.getAll();
                const lowStock = products.filter(p => p.stock <= 10 && p.stock > 0);

                document.getElementById('low-stock').innerHTML = Components.renderTable({
                    data: lowStock,
                    columns: [
                        { label: '–¢–æ–≤–∞—Ä', field: 'title' },
                        { label: 'SKU', field: 'sku' },
                        { label: '–û—Å—Ç–∞—Ç–æ–∫', field: 'stock', render: (row) => `<span class="text-error">${row.stock}</span>` }
                    ],
                    emptyMessage: '–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –Ω–∞–ª–∏—á–∏–∏'
                });

            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
                Components.showToast('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'error');
            }
        }

        function viewOrder(id) {
            window.location.href = `order-view.html?id=${id}`;
        }

        // Sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });

        // Global search
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) {
                e.preventDefault();
                document.getElementById('global-search').focus();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initDashboard, 300);
        });
    </script>
</body>

</html>