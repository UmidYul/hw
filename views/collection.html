<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Коллекция · AURA</title>
    <meta name="description" content="Коллекции AURA — подборки товаров по сезонам и стилям.">
    <meta property="og:site_name" content="AURA">
    <meta property="og:title" content="Коллекция · AURA">
    <meta property="og:description" content="Коллекции AURA — подборки товаров по сезонам и стилям.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://higherwaist.uz/collection">
    <meta property="og:image" content="https://higherwaist.uz/images/logo.PNG">
    <link rel="canonical" href="https://higherwaist.uz/collection">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Cormorant+Garamond:wght@300;400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
    <div id="siteHeader"></div>

    <!-- Collection Page -->
    <div class="catalog-page">
        <div class="container">
            <!-- Breadcrumbs -->
            <nav class="breadcrumbs" aria-label="breadcrumb">
                <a href="/">Главная</a>
                <span>/</span>
                <a href="/catalog">Каталог</a>
                <span>/</span>
                <span id="breadcrumbCurrent">Коллекция</span>
            </nav>

            <!-- Collection Header -->
            <div class="collection-header">
                <h1 class="page-title" id="collectionTitle">Загрузка...</h1>
                <p class="collection-description" id="collectionDescription"></p>
            </div>

            <!-- Products Grid -->
            <div class="products-section">
                <div class="products-count" id="productsCount">
                    <span id="productsTotal">0</span> товаров
                </div>

                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <p>Загрузка товаров...</p>
                </div>

                <!-- Error State -->
                <div class="error-state" id="errorState" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Коллекция не найдена</h3>
                    <p>Эта коллекция больше не доступна или была удалена.</p>
                    <a href="/catalog" class="btn btn-primary">Перейти в каталог</a>
                </div>

                <!-- Empty State -->
                <div class="empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-box-open"></i>
                    <h3>В коллекции пока нет товаров</h3>
                    <p>Скоро здесь появятся новые товары. Следите за обновлениями!</p>
                    <a href="/catalog" class="btn btn-primary">Перейти в каталог</a>
                </div>

                <!-- Products Grid -->
                <div class="products-grid products-grid-3" id="productsGrid"></div>
            </div>
        </div>
    </div>

    <div id="siteFooter"></div>

    <script src="/js/data.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/layout.js"></script>
    <script src="/js/app.js"></script>
    <script>
        const BASE_URL = 'https://higherwaist.uz';
        const params = new URLSearchParams(window.location.search);
        const collectionSlug = params.get('slug');

        const collectionTitle = document.getElementById('collectionTitle');
        const collectionDescription = document.getElementById('collectionDescription');
        const breadcrumbCurrent = document.getElementById('breadcrumbCurrent');
        const productsTotal = document.getElementById('productsTotal');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const emptyState = document.getElementById('emptyState');

        function setMetaTag(name, content, isProperty = false) {
            const selector = isProperty ? `meta[property="${name}"]` : `meta[name="${name}"]`;
            let element = document.querySelector(selector);

            if (!element) {
                element = document.createElement('meta');
                if (isProperty) {
                    element.setAttribute('property', name);
                } else {
                    element.setAttribute('name', name);
                }
                document.head.appendChild(element);
            }

            element.setAttribute('content', content);
        }

        function setCanonical(url) {
            let link = document.querySelector('link[rel="canonical"]');
            if (!link) {
                link = document.createElement('link');
                link.rel = 'canonical';
                document.head.appendChild(link);
            }
            link.href = url;
        }

        function updateCollectionSeo(collection) {
            const name = collection.name || collection.title || 'Коллекция';
            const description = (collection.description || 'Коллекции AURA.')
                .replace(/<[^>]*>/g, '')
                .trim();
            const shortDescription = description.length > 160
                ? `${description.slice(0, 157)}...`
                : description;
            const canonicalUrl = `${BASE_URL}/collection?slug=${encodeURIComponent(collection.slug || '')}`;

            document.title = `${name} · AURA`;
            setMetaTag('description', shortDescription);
            setMetaTag('og:site_name', 'AURA', true);
            setMetaTag('og:title', `${name} · AURA`, true);
            setMetaTag('og:description', shortDescription, true);
            setMetaTag('og:type', 'website', true);
            setMetaTag('og:url', canonicalUrl, true);
            setMetaTag('og:image', `${BASE_URL}/images/logo.PNG`, true);
            setCanonical(canonicalUrl);
        }

        function showError() {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            emptyState.style.display = 'none';
            document.getElementById('productsGrid').innerHTML = '';
            collectionTitle.textContent = 'Коллекция не найдена';
        }

        function showEmpty() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            emptyState.style.display = 'block';
            document.getElementById('productsGrid').innerHTML = '';
        }

        async function loadCollection() {
            if (!collectionSlug) {
                showError();
                return;
            }

            try {
                loadingState.style.display = 'block';
                errorState.style.display = 'none';
                emptyState.style.display = 'none';
                document.getElementById('productsGrid').innerHTML = '';

                const response = await fetch(`/api/collections/slug/${encodeURIComponent(collectionSlug)}`);

                if (!response.ok) {
                    throw new Error('Collection not found');
                }

                const data = await response.json();
                const products = Array.isArray(data.products) ? data.products : [];
                const collectionName = data.name || data.title || 'Коллекция';

                collectionTitle.textContent = collectionName;
                breadcrumbCurrent.textContent = collectionName;
                updateCollectionSeo(data);

                if (data.description) {
                    collectionDescription.textContent = data.description;
                    collectionDescription.style.display = 'block';
                } else {
                    collectionDescription.style.display = 'none';
                }

                loadingState.style.display = 'none';

                if (products.length === 0) {
                    showEmpty();
                    return;
                }

                productsTotal.textContent = products.length;
                renderProducts(products, 'productsGrid');
            } catch (error) {
                console.error('Error loading collection:', error);
                loadingState.style.display = 'none';
                showError();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCollection();
        });
    </script>
</body>

</html>